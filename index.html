<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon TCG Tracker - Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <script type="module">
        // --- Firebase SDKs ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM References ---
        // Views
        const searchView = document.getElementById('searchView');
        const myListFullPage = document.getElementById('myListFullPage');
        const setsPage = document.getElementById('setsPage');
        const setViewPage = document.getElementById('setViewPage');
        const wantsListPage = document.getElementById('wantsListPage');

        // Main Search
        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('results');
        
        // Modals & Popups
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalDetailsContainer = document.getElementById('modalDetailsContainer');
        const closeModalButton = document.getElementById('closeModal');
        const loginModal = document.getElementById('loginModal');
        const toastContainer = document.getElementById('toast-container');

        // Navigation & General UI
        const collectionStatsContainer = document.getElementById('collectionStatsContainer');
        const showListBtn = document.getElementById('showListBtn');
        const showSetsBtn = document.getElementById('showSetsBtn');
        const showWantsBtn = document.getElementById('showWantsBtn');
        const userDisplay = document.getElementById('userDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const statusDisplay = document.getElementById('statusDisplay');
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        // Login Form
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const confirmPasswordInput = document.getElementById('confirmPasswordInput');
        const loginError = document.getElementById('loginError');
        const loginTitle = document.getElementById('loginTitle');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const toggleAuthMode = document.getElementById('toggleAuthMode');
        
        // "My List" Page
        const myListFullPageContainer = document.getElementById('myListFullPageContainer');
        const myListSortControlsContainer = document.getElementById('myListSortControls'); 
        const myListFilterControls = document.getElementById('myListFilterControls');
        const myListLetterFilters = document.getElementById('myListLetterFilters');
        const myListRangeFilters = document.getElementById('myListRangeFilters');
        const myListGridViewBtn = document.getElementById('myListGridViewBtn');
        const myListListViewBtn = document.getElementById('myListListViewBtn');
        const backToSearchBtnMyList = document.getElementById('backToSearchBtnMyList');
        const calculateValueBtn = document.getElementById('calculateValueBtn');
        const totalValueDisplay = document.getElementById('totalValueDisplay');
        
        // "Wants List" Page
        const wantsListContainer = document.getElementById('wantsListContainer');
        const backToSearchBtnWants = document.getElementById('backToSearchBtnWants');
        const searchSortControls = document.getElementById('searchSortControls');

        // "Sets" Page
        const setsContainer = document.getElementById('setsContainer');
        const setsStatus = document.getElementById('setsStatus');
        const backToSearchBtnSets = document.getElementById('backToSearchBtnSets');
        
        // "Set View" Page
        const setViewContainer = document.getElementById('setViewContainer');
        const setViewHeader = document.getElementById('setViewHeader');
        const setViewProgressText = document.getElementById('setViewProgressText');
        const setViewProgressBar = document.getElementById('setViewProgressBar');
        const backToSetsBtn = document.getElementById('backToSetsBtn');


        // --- State and Config ---
        const TOTAL_POKEMON_SPECIES = 1025; 
        let completionList = [];
        let wantsList = [];
        let currentUser = null;
        let unsubscribeFromCollection = null;
        let unsubscribeFromWants = null;
        let currentView = 'grid';
        let myListView = 'grid';
        let lastDisplayedCards = [];
        let localCardDatabase = {}; 
        let localSetDatabase = [];
        let isRegistering = false;
        let searchSort = { field: 'pokedex', direction: 'asc' };
        let myListSort = { field: 'pokedex', direction: 'asc' };
        let currentFilter = { type: 'all', value: null };
        let currentPage = 'search'; 

        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyBqKvL31__K5UZo-iwjO7uN5zPN4t8aDn4",
          authDomain: "poke-c7d03.firebaseapp.com",
          projectId: "poke-c7d03",
          storageBucket: "poke-c7d03.firebasestorage.app",
          messagingSenderId: "567243781113",
          appId: "1:567243781113:web:53c5a8e442b4967cdb4328"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;

        // --- IndexedDB Caching for Card Database ---
        const POKE_DB_NAME = 'PokemonTCGDB';
        const POKE_CARDS_STORE_NAME = 'cards';
        const POKE_DB_VERSION = 1; // Increment to force a full re-sync

        function openPokemonDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(POKE_DB_NAME, POKE_DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (db.objectStoreNames.contains(POKE_CARDS_STORE_NAME)) {
                        db.deleteObjectStore(POKE_CARDS_STORE_NAME);
                    }
                    db.createObjectStore(POKE_CARDS_STORE_NAME, { keyPath: 'id' });
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.error);
                    reject("Error opening Pokémon DB.");
                };
            });
        }

        function getCardsFromDB(db) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([POKE_CARDS_STORE_NAME], 'readonly');
                const store = transaction.objectStore(POKE_CARDS_STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(`Error getting cards from DB: ${event.target.error}`);
            });
        }

        function saveCardsToDB(db, cards) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([POKE_CARDS_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(POKE_CARDS_STORE_NAME);
                const clearRequest = store.clear();
                clearRequest.onerror = (event) => reject(`Error clearing store: ${event.target.error}`);
                clearRequest.onsuccess = () => {
                    cards.forEach(card => {
                        store.put(card);
                    });
                };
                transaction.oncomplete = () => {
                    console.log(`${cards.length} cards saved to IndexedDB successfully.`);
                    resolve();
                };
                transaction.onerror = (event) => {
                    console.error('Transaction error while saving cards:', event.target.error);
                    reject('Error saving cards to DB.');
                };
            });
        }

        // --- Firestore References ---
        const usersCollection = collection(db, 'users');

        // --- Helper for Type/Energy Icons ---
        const typeColors = {
            Colorless: '#A8A77A', Fire: '#EE8130', Water: '#6390F0', Grass: '#7AC74C',
            Lightning: '#F7D02C', Fighting: '#C22E28', Psychic: '#F95587', Darkness: '#705746',
            Metal: '#B7B7CE', Dragon: '#6F35FC', Fairy: '#D685AD',
        };

        function getTypeIcon(type, size = 'w-4 h-4') {
            const color = typeColors[type] || '#ccc';
            return `<span class="inline-flex items-center justify-center ${size} rounded-full border border-gray-600 dark:border-gray-400 align-middle mr-1 game-box-thin" style="background-color: ${color};">
                        <span class="type-icon-text leading-none">${type.substring(0,1).toUpperCase()}</span>
                    </span>`;
        }

        function formatCosts(costs) {
            if (!costs || costs.length === 0) return '';
            return costs.map(cost => getTypeIcon(cost, 'w-5 h-5')).join('');
        }

        // --- UI Functions ---
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = message;
            toastContainer.innerHTML = ''; 
            toastContainer.appendChild(toast); 
        }

        function navigateTo(page) {
            currentPage = page;
            searchView.classList.add('hidden');
            myListFullPage.classList.add('hidden');
            setsPage.classList.add('hidden');
            setViewPage.classList.add('hidden');
            wantsListPage.classList.add('hidden');

            if (page === 'myList') {
                myListFullPage.classList.remove('hidden');
                renderCompletionList();
            } else if (page === 'wantsList') {
                wantsListPage.classList.remove('hidden');
                renderWantsList();
            } else if (page === 'sets') {
                setsPage.classList.remove('hidden');
                renderSets();
            } else if (page.startsWith('setView_')) {
                setViewPage.classList.remove('hidden');
                const setId = page.split('_')[1];
                renderSetView(setId);
            } else { // 'search'
                searchView.classList.remove('hidden');
                displayCards(lastDisplayedCards);
            }
        }
        
        function updateCollectionStats() {
            if (!collectionStatsContainer) return;

            const totalCards = completionList.length;
            const uniquePokedex = new Set(completionList.map(c => c.pokedex)).size;
            const uniqueSets = new Set(completionList.map(c => c.set.id)).size;
            const wantsCount = wantsList.length;
            const percentage = (uniquePokedex / TOTAL_POKEMON_SPECIES) * 100;

            collectionStatsContainer.innerHTML = `
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-3 text-xs mb-3">
                    <div class="font-bold">TOTAL CARDS: <span class="font-normal text-blue-600 dark:text-blue-400">${totalCards}</span></div>
                    <div class="font-bold">UNIQUE SETS: <span class="font-normal text-blue-600 dark:text-blue-400">${uniqueSets}</span></div>
                    <div class="font-bold">WANTS LIST: <span class="font-normal text-red-600 dark:text-red-400">${wantsCount}</span></div>
                </div>
                 <div class="w-full">
                    <div class="flex justify-between items-center mb-1 text-xs">
                        <span class="font-semibold">UNIQUE SPECIES</span>
                        <span class="font-bold">${uniquePokedex}/${TOTAL_POKEMON_SPECIES}</span>
                    </div>
                    <div class="progress-container"><div class="progress-bar-inner" style="width: ${percentage.toFixed(1)}%"></div></div>
                </div>
            `;
        }

        function setActiveView(view, list = 'search') {
            if (list === 'search') {
                currentView = view;
                gridViewBtn.classList.toggle('game-btn-active', view === 'grid');
                listViewBtn.classList.toggle('game-btn-active', view === 'list');
                displayCards(lastDisplayedCards);
            } else { 
                myListView = view;
                myListGridViewBtn.classList.toggle('game-btn-active', view === 'grid');
                myListListViewBtn.classList.toggle('game-btn-active', view === 'list');
                renderCompletionList();
            }
        }
        
        function showStatus(message, isError = false, target = statusDisplay) {
            target.textContent = message;
            target.classList.toggle('text-red-500', isError);
            if (message && !isError) {
                setTimeout(() => { 
                    if(target.textContent === message) target.textContent = ''
                }, 3000);
            }
        }

        // --- Firestore Data Functions ---
        async function saveDataToFirestore(collectionName, data) {
            if (!currentUser) return;
            try {
                const userDocRef = doc(usersCollection, currentUser.uid);
                const subCollectionRef = collection(userDocRef, collectionName);
                const dataDocRef = doc(subCollectionRef, 'data');
                await setDoc(dataDocRef, { list: data });
            } catch (error) { console.error(`Error saving ${collectionName}:`, error); }
        }

        function listenToUserData(userId) {
            if (unsubscribeFromCollection) unsubscribeFromCollection();
            if (unsubscribeFromWants) unsubscribeFromWants();

            const userDocRef = doc(usersCollection, userId);
            const collectionDocRef = doc(collection(userDocRef, 'collection'), 'data');
            const wantsDocRef = doc(collection(userDocRef, 'wants'), 'data');
            
            unsubscribeFromCollection = onSnapshot(collectionDocRef, (docSnap) => {
                completionList = docSnap.exists() ? docSnap.data().list || [] : [];
                
                if (currentPage === 'myList') {
                    renderCompletionList();
                } else if (currentPage.startsWith('setView_')) {
                    // Re-render the set view to update collected status
                    navigateTo(currentPage); 
                } else if (lastDisplayedCards.length > 0) {
                    updateAllCardViews();
                }
                updateCollectionStats();
            });

            unsubscribeFromWants = onSnapshot(wantsDocRef, (docSnap) => {
                wantsList = docSnap.exists() ? docSnap.data().list || [] : [];

                if (currentPage === 'wantsList') {
                    renderWantsList();
                } else if (lastDisplayedCards.length > 0) {
                    updateAllCardViews();
                }
                updateCollectionStats();
            });
        }

        // --- Core App Logic ---
        async function addToList(card) {
            if (!currentUser || completionList.some(item => item.id === card.id)) return;
            showToast(`Added ${card.name} to your list!`);

            const userDocRef = doc(usersCollection, currentUser.uid);
            const collectionDataDocRef = doc(collection(userDocRef, 'collection'), 'data');
            const wantsDataDocRef = doc(collection(userDocRef, 'wants'), 'data');

            const newEntry = {
                id: card.id, name: card.name, number: card.number || null, pokedex: card.nationalPokedexNumbers?.[0] || null,
                nationalPokedexNumbers: card.nationalPokedexNumbers || null, set: card.set || null, hp: card.hp || null, types: card.types || null,
                rarity: card.rarity || null, artist: card.artist || null, supertype: card.supertype || null, subtype: card.subtype || null
            };
            
            const wantsEntry = wantsList.find(item => item.id === card.id);
            const promises = [];
            
            const addPromise = updateDoc(collectionDataDocRef, { list: arrayUnion(newEntry) })
                .catch(e => e.code === 'not-found' ? setDoc(collectionDataDocRef, { list: [newEntry] }) : Promise.reject(e));
            promises.push(addPromise);

            if (wantsEntry) {
                const removePromise = updateDoc(wantsDataDocRef, { list: arrayRemove(wantsEntry) })
                    .catch(e => e.code === 'not-found' ? Promise.resolve() : Promise.reject(e)); // Ignore not-found on remove
                promises.push(removePromise);
            }

            try {
                await Promise.all(promises);
            } catch (e) {
                console.error("Error moving card from wants to collection:", e);
                showToast(`Error: Could not save ${card.name}`, true);
            }
        }
        
        async function addToWants(card) {
            if (!currentUser || wantsList.some(item => item.id === card.id) || completionList.some(item => item.id === card.id)) return;
            showToast(`Added ${card.name} to your wants list!`);

            const userDocRef = doc(usersCollection, currentUser.uid);
            const wantsDataDocRef = doc(collection(userDocRef, 'wants'), 'data');
            
            const newEntry = {
                id: card.id, name: card.name, number: card.number || null, pokedex: card.nationalPokedexNumbers?.[0] || null,
                nationalPokedexNumbers: card.nationalPokedexNumbers || null, set: card.set || null, hp: card.hp || null, types: card.types || null,
                rarity: card.rarity || null, artist: card.artist || null, supertype: card.supertype || null, subtype: card.subtype || null
            };

            try {
                await updateDoc(wantsDataDocRef, { list: arrayUnion(newEntry) });
            } catch (e) {
                if (e.code === 'not-found') {
                    try {
                        await setDoc(wantsDataDocRef, { list: [newEntry] });
                    } catch (e2) {
                        console.error("Error setting initial wants list:", e2);
                        showToast(`Error: Could not save ${card.name}`, true);
                    }
                } else {
                    console.error("Error adding to wants list:", e);
                    showToast(`Error: Could not save ${card.name}`, true);
                }
            }
        }
        
        async function removeFromWants(cardId) {
            if (!currentUser) return;
            const wantsEntry = wantsList.find(item => item.id === cardId);
            if (!wantsEntry) return;

            const userDocRef = doc(usersCollection, currentUser.uid);
            const wantsDataDocRef = doc(collection(userDocRef, 'wants'), 'data');

            try {
                await updateDoc(wantsDataDocRef, { list: arrayRemove(wantsEntry) });
            } catch (e) {
                console.error("Error removing from wants list:", e);
            }
        }

        async function removeFromList(cardId) {
            if (!currentUser) return;
            const removedItem = completionList.find(item => item.id === cardId);
            if (!removedItem) return;

            showToast(`${removedItem.name} was removed from the list.`);
            
            const userDocRef = doc(usersCollection, currentUser.uid);
            const collectionDataDocRef = doc(collection(userDocRef, 'collection'), 'data');

            try {
                await updateDoc(collectionDataDocRef, { list: arrayRemove(removedItem) });
            } catch (e) {
                console.error("Error removing from collection:", e);
            }
        }
        
        function updateAllCardViews() {
            document.querySelectorAll('[data-card-id]').forEach(el => {
                updateSingleCardView(el.dataset.cardId);
            });
        }

        function updateSingleCardView(cardId) {
             document.querySelectorAll(`[data-card-id="${cardId}"] .card-btn-container`).forEach(container => {
                 const cardData = localCardDatabase[cardId];
                 if (cardData) {
                    const isCollected = completionList.some(item => item.id === cardId);
                    const isWanted = wantsList.some(item => item.id === cardId);
                    container.innerHTML = createCardButtons(cardData, isCollected, isWanted);
                 }
             });
        }
        
        // --- Sorting and Filtering ---
        function sortCards(cards, sortConfig) {
            return [...cards].sort((a, b) => {
                let valA, valB;
                switch (sortConfig.field) {
                    case 'pokedex':
                        valA = a.nationalPokedexNumbers?.[0] || a.pokedex || Infinity;
                        valB = b.nationalPokedexNumbers?.[0] || b.pokedex || Infinity;
                        break;
                    case 'name': valA = a.name; valB = b.name; break;
                    case 'hp': valA = parseInt(a.hp) || 0; valB = parseInt(b.hp) || 0; break;
                    case 'releaseDate':
                        valA = new Date(a.set?.releaseDate || '1900-01-01');
                        valB = new Date(b.set?.releaseDate || '1900-01-01');
                        break;
                    case 'rarity': valA = a.rarity || ''; valB = b.rarity || ''; break;
                    default: return 0;
                }
                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        function setMyListFilter(type, value) {
            currentFilter = { type, value };
            renderCompletionList(); 
        }

        function createSortControls(container, sortState, onSortChange) {
            container.innerHTML = `
                <label for="${container.id}-select" class="font-bold text-xs mr-2">SORT BY:</label>
                <select id="${container.id}-select" class="game-input text-xs p-2 sort-select">
                    <option value="pokedex">Pokédex #</option>
                    <option value="name">Name</option>
                    <option value="hp">HP</option>
                    <option value="releaseDate">Release Date</option>
                    <option value="rarity">Rarity</option>
                </select>
                <button class="game-btn p-2 text-xs sort-direction-btn">▲</button>
            `;
            const select = container.querySelector('.sort-select');
            const directionBtn = container.querySelector('.sort-direction-btn');
            select.value = sortState.field;
            directionBtn.innerHTML = sortState.direction === 'asc' ? '▲' : '▼';

            select.addEventListener('change', (e) => {
                sortState.field = e.target.value;
                onSortChange();
            });
            directionBtn.addEventListener('click', () => {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                directionBtn.innerHTML = sortState.direction === 'asc' ? '▲' : '▼';
                onSortChange();
            });
        }

        function renderCompletionList() {
            const container = myListFullPageContainer;
            container.innerHTML = '';
            
            let filteredList = completionList;
            if(currentFilter.type === 'letter'){
                filteredList = completionList.filter(item => item.name.toUpperCase().startsWith(currentFilter.value));
            } else if (currentFilter.type === 'range'){
                const [min, max] = currentFilter.value.split('-').map(Number);
                filteredList = completionList.filter(item => item.pokedex >= min && item.pokedex <= max);
            }

            const sortedList = sortCards(filteredList, myListSort);
            
            if (sortedList.length === 0) {
                container.innerHTML = `<div class="text-center p-4 text-gray-500 dark:text-gray-400">Your collection is empty.</div>`;
                return;
            }

            if (myListView === 'grid') {
                container.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 custom-scrollbar';
                sortedList.forEach(card => container.appendChild(createCardElement(card, displayCardAsGridTemplate(card))));
            } else {
                container.className = 'space-y-4 custom-scrollbar';
                sortedList.forEach(card => container.appendChild(createCardElement(card, displayCardAsListTemplate(card))));
            }
        }
        
        function renderWantsList() {
            wantsListContainer.innerHTML = '';
            const sortedList = sortCards(wantsList, myListSort);
            if (sortedList.length === 0) {
                wantsListContainer.innerHTML = `<div class="text-center p-4 text-gray-500 dark:text-gray-400">Your wants list is empty.</div>`;
                return;
            }
            wantsListContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 custom-scrollbar';
            sortedList.forEach(card => wantsListContainer.appendChild(createCardElement(card, displayCardAsGridTemplate(card))));
        }

        function displayCardAsGridTemplate(card) {
            return `<div>
                <div class="text-center game-box p-2 flex flex-col justify-between h-full">
                    <div>
                        <div class="img-placeholder">
                            <img alt="${card.name}" class="card-image w-full cursor-pointer opacity-0" loading="lazy">
                        </div>
                        <div class="mt-2 text-xs">
                            <p class="font-bold truncate" title="${card.name}">${card.name}</p>
                            <div class="card-details-info text-[10px] mt-1 mb-1 min-h-[42px]"></div>
                        </div>
                    </div>
                    <div class="card-btn-container mt-auto"></div>
                </div>
            </div>`;
        }
        
        function displayCardAsListTemplate(card) {
            return `<div>
                <div class="game-box p-3 flex flex-col sm:flex-row items-center gap-4">
                    <div class="img-placeholder w-20 h-28 flex-shrink-0">
                        <img alt="${card.name}" class="card-image w-20 h-28 object-cover cursor-pointer opacity-0" loading="lazy">
                    </div>
                    <div class="flex-grow text-center sm:text-left">
                        <p class="font-bold text-base" title="${card.name}">${card.name}</p>
                        <div class="card-details-info text-xs mt-1 mb-1"></div>
                    </div>
                    <div class="card-btn-container w-full sm:w-auto"></div>
                </div>
            </div>`;
        }


        // --- Database Sync ---
        async function syncLocalDatabases() {
            const cardDbUrl = 'https://raw.githubusercontent.com/codesbyabdi/poke/main/pokemon-tcg-db.json'; 
            const setDbUrl = 'https://api.pokemontcg.io/v2/sets';

            const syncSets = async () => {
                try {
                    const response = await fetch(setDbUrl);
                    if (!response.ok) throw new Error('Failed to fetch sets');
                    const setData = await response.json();
                    localSetDatabase = setData.data.sort((a,b) => new Date(b.releaseDate) - new Date(a.releaseDate));
                } catch (e) {
                    console.error("Set DB Sync Failed", e);
                    showStatus('Could not load set data.', true, setsStatus);
                }
            };

            const syncCards = async () => {
                try {
                    showStatus('Connecting to card database...');
                    const db = await openPokemonDB();
                    const cachedCards = await getCardsFromDB(db);

                    if (cachedCards && cachedCards.length > 0) {
                        showStatus('Loading database from cache...');
                        console.log(`Loaded ${cachedCards.length} cards from IndexedDB.`);
                        localCardDatabase = {};
                        cachedCards.forEach(card => localCardDatabase[card.id] = card);
                        showStatus(''); // Clear status on success
                        return;
                    }
                    
                    showStatus('SYNCING DATABASE (first load might take a moment)...');
                    console.log("Card cache is empty or outdated, fetching from network...");

                    const response = await fetch(cardDbUrl);
                    if (!response.ok) throw new Error(`Network response not ok. Status: ${response.status}`);
                    const dataArray = await response.json(); 
                    
                    console.log(`Fetched ${dataArray.length} cards, saving to cache...`);
                    await saveCardsToDB(db, dataArray);
                    
                    localCardDatabase = {};
                    dataArray.forEach(card => localCardDatabase[card.id] = card);

                } catch (error) { 
                    showStatus(`DB SYNC FAILED: ${error.message}`, true); 
                    searchInput.placeholder = "DB Load Failed. Refresh.";
                    console.error("Error during card sync:", error);
                }
            };
            
            await Promise.all([syncCards(), syncSets()]);
        }

        // --- Local Search ---
        function getAutocompleteSuggestions(query) {
            if (!query || Object.keys(localCardDatabase).length === 0) return displayAutocomplete([]);
            const lowerCaseQuery = query.toLowerCase();
            const suggestions = new Set(); 
            for (const cardId in localCardDatabase) {
                const card = localCardDatabase[cardId];
                if (card.name && card.name.toLowerCase().startsWith(lowerCaseQuery)) {
                    suggestions.add(card.name);
                }
                if (suggestions.size >= 100) break; 
            }
            displayAutocomplete(Array.from(suggestions).slice(0, 5));
        }

        function searchLocalDatabase(query) {
            showStatus('SEARCHING...');
            if (!query) {
                lastDisplayedCards = [];
                resultsContainer.innerHTML = '';
                showStatus('');
                return;
            }
            
            const isPokedexNumber = /^\d+$/.test(query);
            const lowerCaseQuery = query.toLowerCase();
            let results = [];

            for (const cardId in localCardDatabase) {
                if (!Object.prototype.hasOwnProperty.call(localCardDatabase, cardId)) continue;
                const card = localCardDatabase[cardId];
                if (isPokedexNumber) {
                    if (Array.isArray(card.nationalPokedexNumbers) && card.nationalPokedexNumbers.includes(parseInt(query, 10))) {
                        results.push(card);
                    }
                } else if (card.name && card.name.toLowerCase().includes(lowerCaseQuery)) {
                    results.push(card);
                }
            }
            
            lastDisplayedCards = results;
            displayCards(lastDisplayedCards);

            if(lastDisplayedCards.length === 0) showStatus(`No cards found for "${query}".`, true);
            else showStatus(`${lastDisplayedCards.length} cards found.`);
        }

        // --- Display Functions ---
        function displayAutocomplete(names) {
            autocompleteResults.innerHTML = '';
            if (names.length === 0) return autocompleteResults.classList.add('hidden');
            names.forEach(name => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = name;
                item.onclick = () => {
                    searchInput.value = name;
                    autocompleteResults.classList.add('hidden');
                    searchLocalDatabase(name);
                };
                autocompleteResults.appendChild(item);
            });
            autocompleteResults.classList.remove('hidden');
        }

        function displayCards(cards) {
            resultsContainer.innerHTML = '';
            const sortedCards = sortCards(cards, searchSort);

            if (sortedCards.length === 0) return;

            if (currentView === 'grid') {
                resultsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4';
                sortedCards.forEach(card => resultsContainer.appendChild(createCardElement(card, displayCardAsGridTemplate(card))));
            } else {
                resultsContainer.className = 'space-y-4';
                sortedCards.forEach(card => resultsContainer.appendChild(createCardElement(card, displayCardAsListTemplate(card))));
            }
        }
        
        function showCardDetailsModal(card) {
            const pokedexNumber = card.nationalPokedexNumbers?.[0] || card.pokedex || 'N/A';
            const largeImageUrl = `https://images.pokemontcg.io/${card.set?.id}/${card.number}_hires.png`;
            modalImage.src = largeImageUrl;
            modalImage.onerror = () => { modalImage.src = `https://images.pokemontcg.io/${card.set?.id}/${card.number}.png`; }
            
            const addDetailRow = (label, value) => {
                if (!value || (Array.isArray(value) && value.length === 0)) return '';
                return `<p class="text-xs"><span class="font-bold uppercase">${label}:</span> ${value}</p>`;
            };

            const addThemedSection = (title, contentHtml) => {
                if (!contentHtml || !contentHtml.trim()) return '';
                return `
                    <div class="game-box p-3 mb-4">
                        <h3 class="text-sm font-bold mb-2 uppercase text-blue-800 dark:text-blue-400 border-b-2 border-gray-300 dark:border-gray-600 pb-1">${title}</h3>
                        <div class="space-y-2">${contentHtml}</div>
                    </div>
                `;
            };

            let detailsHtml = `
                <div class="mb-4">
                    <h2 class="text-3xl font-black mb-1 text-red-700 dark:text-red-500 uppercase leading-none">${card.name}</h2>
                    <div class="flex items-center text-lg font-bold text-gray-800 dark:text-gray-200 leading-none">
                        ${card.hp ? `<span class="text-red-600 dark:text-red-500 mr-2">HP ${card.hp}</span> ` : ''}
                        ${card.types?.map(type => getTypeIcon(type, 'w-6 h-6')).join('') || ''}
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                        #${String(pokedexNumber).padStart(3, '0')} ${card.supertype || ''} Pokémon
                    </p>
                </div>
            `;

            detailsHtml += addThemedSection('Market Value', `<div id="price-container"><p class="text-xs text-gray-500">Loading price...</p></div>`);

            if (card.attacks?.length > 0) {
                let attacksHtml = card.attacks.map(attack => `<div><p class="font-bold text-gray-900 dark:text-gray-100 flex justify-between items-center"><span class="flex items-center gap-1">${formatCosts(attack.cost)} ${attack.name}</span>${attack.damage ? `<span class="text-blue-600 dark:text-blue-400">${attack.damage} Damage</span>` : ''}</p>${attack.text ? `<p class="text-xs text-gray-600 dark:text-gray-400 leading-tight mt-1">${attack.text}</p>`: ''}</div>`).join('');
                detailsHtml += addThemedSection('Attacks', attacksHtml);
            }
            
            let statsHtml = '';
            if (card.weaknesses?.length > 0) statsHtml += `<p class="text-xs font-bold">Weakness: ${card.weaknesses.map(w => `${getTypeIcon(w.type, 'w-4 h-4')} ${w.value}`).join(', ')}</p>`;
            if (card.resistances?.length > 0) statsHtml += `<p class="text-xs font-bold">Resistance: ${card.resistances.map(r => `${getTypeIcon(r.type, 'w-4 h-4')} ${r.value}`).join(', ')}</p>`;
            if (card.retreatCost?.length > 0) statsHtml += `<p class="text-xs font-bold">Retreat Cost: ${formatCosts(card.retreatCost)}</p>`;
            if (statsHtml) detailsHtml += addThemedSection('Stats', statsHtml);

            let cardInfoHtml = `${addDetailRow('Set', card.set?.name)} ${addDetailRow('Rarity', card.rarity)} ${addDetailRow('Artist', card.artist)} ${addDetailRow('Release', card.set?.releaseDate)}`;
            detailsHtml += addThemedSection('Card Info', cardInfoHtml);
            
            if (card.flavorText) detailsHtml += addThemedSection('Flavor Text', `<p class="text-xs italic text-gray-600 dark:text-gray-400 leading-tight">"${card.flavorText}"</p>`);
            
            modalDetailsContainer.innerHTML = detailsHtml; 
            imageModal.classList.remove('hidden'); 

            // Asynchronously fetch price
            fetch(`https://api.pokemontcg.io/v2/cards/${card.id}`)
                .then(res => res.json())
                .then(priceData => {
                    const priceContainer = document.getElementById('price-container');
                    if (!priceContainer) return;

                    const marketPrices = priceData.data?.tcgplayer?.prices;
                    if (marketPrices) {
                        const priceHtml = Object.entries(marketPrices).map(([rarity, prices]) => {
                            if (!prices.market) return '';
                            return `<div class="flex justify-between items-center text-xs"><span class="capitalize font-bold">${rarity.replace(/([A-Z])/g, ' $1').trim()}:</span> <span class="text-green-600 dark:text-green-400 font-bold">$${prices.market.toFixed(2)}</span></div>`;
                        }).join('');
                        priceContainer.innerHTML = priceHtml || '<p class="text-xs font-bold text-gray-500">Price data not available.</p>';
                    } else {
                         priceContainer.innerHTML = '<p class="text-xs font-bold text-gray-500">Price data not available.</p>';
                    }
                })
                .catch(e => {
                     const priceContainer = document.getElementById('price-container');
                     if(priceContainer) priceContainer.innerHTML = '<p class="text-xs font-bold text-red-500">Could not fetch price.</p>';
                     console.error("Could not fetch price data", e)
                });
        }
        
        async function calculateCollectionValue() {
            calculateValueBtn.disabled = true;
            totalValueDisplay.innerHTML = `TOTAL VALUE: <span class="font-normal text-blue-600 dark:text-blue-400">Calculating...</span>`;
            
            let totalValue = 0;
            const pricePromises = completionList.map(card => 
                fetch(`https://api.pokemontcg.io/v2/cards/${card.id}`)
                    .then(res => res.json())
                    .then(data => {
                        const prices = data.data?.tcgplayer?.prices;
                        if (prices) {
                            const priceTypes = ['holofoil', 'reverseHolofoil', '1stEditionHolofoil', 'unlimitedHolofoil', 'normal'];
                            for (const type of priceTypes) {
                                if (prices[type]?.market) {
                                    return prices[type].market;
                                }
                            }
                        }
                        return 0; // Return 0 if no price found
                    })
                    .catch(() => 0) // Return 0 on error
            );

            const prices = await Promise.all(pricePromises);
            totalValue = prices.reduce((sum, price) => sum + price, 0);

            totalValueDisplay.innerHTML = `TOTAL VALUE: <span class="font-normal text-green-600 dark:text-green-400">$${totalValue.toFixed(2)}</span>`;
            calculateValueBtn.disabled = false;
        }


        function createCardButtons(card, isCollected, isWanted) {
            if (isCollected) {
                return `<button class="w-full game-btn py-2 px-2 text-xs game-btn-danger" onclick="this.dispatchEvent(new CustomEvent('removeFromList', { bubbles: true, detail: { cardId: '${card.id}' } }))">REMOVE</button>`;
            }
            if (isWanted) {
                return `<div class="flex gap-1.5 mt-auto">
                    <button class="w-2/3 game-btn py-2 px-2 text-xs game-btn-success" onclick="this.dispatchEvent(new CustomEvent('addToList', { bubbles: true, detail: { cardId: '${card.id}' } }))">> GOT IT</button>
                    <button class="w-1/3 game-btn py-2 px-2 text-xs game-btn-danger" title="Remove from Wants List" onclick="this.dispatchEvent(new CustomEvent('removeFromWants', { bubbles: true, detail: { cardId: '${card.id}' } }))">
                        <svg class="w-4 h-4 mx-auto" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>`;
            }
            return `<div class="flex gap-1.5 mt-auto">
                <button class="w-2/3 game-btn py-2 px-2 text-xs game-btn-primary" onclick="this.dispatchEvent(new CustomEvent('addToList', { bubbles: true, detail: { cardId: '${card.id}' } }))">> ADD</button>
                <button class="w-1/3 game-btn py-2 px-2 text-xs" title="Add to Wants List" onclick="this.dispatchEvent(new CustomEvent('addToWants', { bubbles: true, detail: { cardId: '${card.id}' } }))">
                    <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                </button>
            </div>`;
        }

        function createCardElement(card, templateHtml) {
            const cardElement = document.createElement('div');
            cardElement.innerHTML = templateHtml;
            const rootEl = cardElement.firstElementChild;
            rootEl.dataset.cardId = card.id;

            const isCollected = currentUser && completionList.some(item => item.id === card.id);
            const isWanted = currentUser && wantsList.some(item => item.id === card.id);

            const img = rootEl.querySelector('.card-image');
            const imageContainer = rootEl.querySelector('.img-placeholder');
            const smallImageUrl = `https://images.pokemontcg.io/${card.set?.id}/${card.number}.png`;

            const cardDetailsDiv = rootEl.querySelector('.card-details-info');
            if (cardDetailsDiv) {
                const setSymbolUrl = card.set?.images?.symbol;
                const setName = card.set?.name || '';
                const printedTotal = card.set?.printedTotal;
                const cardNumber = card.number || '';
                const rarity = card.rarity || '';
                const pokedexNumber = card.nationalPokedexNumbers?.[0] || card.pokedex;

                let numberString = (cardNumber && printedTotal) ? `${cardNumber}/${printedTotal}` : cardNumber || '';
                let detailsHtml = `
                    <div class="space-y-1 text-left p-1">
                        <div class="flex items-center justify-between text-gray-600 dark:text-gray-400 gap-2" title="Set: ${setName}">
                            <div class="flex items-center gap-1.5 min-w-0">
                                ${setSymbolUrl ? `<img src="${setSymbolUrl}" alt="${setName}" class="h-4 w-4 flex-shrink-0 object-contain">` : '<div class="w-4 h-4"></div>'}
                                <span class="truncate font-semibold">${setName}</span>
                            </div>
                            <span class="font-bold whitespace-nowrap">${numberString}</span>
                        </div>
                        <div class="flex items-center justify-between text-gray-600 dark:text-gray-400" title="Rarity: ${rarity} | Pokédex: #${pokedexNumber ? String(pokedexNumber).padStart(3, '0') : 'N/A'}">
                            <span class="capitalize truncate">${rarity}</span>
                            ${pokedexNumber ? `<span>#${String(pokedexNumber).padStart(3, '0')}</span>` : '<span></span>'}
                        </div>
                    </div>
                `;
                cardDetailsDiv.innerHTML = detailsHtml;
            }
            
            if(img && imageContainer) {
                const imageLoader = new Image();
                if (card.set?.id && card.number) {
                    imageLoader.src = smallImageUrl;
                    imageLoader.onload = () => { img.src = imageLoader.src; img.classList.remove('opacity-0'); imageContainer.classList.remove('img-placeholder'); };
                    imageLoader.onerror = () => { imageContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-300 dark:bg-gray-700 text-xs p-2 text-center">Image Not Found</div>`; imageContainer.classList.remove('img-placeholder');};
                } else {
                     imageContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-300 dark:bg-gray-700 text-xs p-2 text-center">No Image Data</div>`;
                     imageContainer.classList.remove('img-placeholder');
                }
            }
            
            if (img) {
                img.addEventListener('click', () => {
                    const fullCardData = localCardDatabase[card.id] || card;
                    showCardDetailsModal(fullCardData);
                });
            }

            const buttonContainer = rootEl.querySelector('.card-btn-container');
            if (buttonContainer) {
                buttonContainer.innerHTML = createCardButtons(card, isCollected, isWanted);
            }
            return rootEl;
        }

        async function renderSets() {
            setsContainer.innerHTML = '';
            if (localSetDatabase.length === 0) {
                 showStatus('Loading sets...', false, setsStatus);
                 return;
            }
            localSetDatabase.forEach(set => {
                const setEl = document.createElement('div');
                setEl.className = 'game-box p-3 flex items-center gap-4 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors';
                setEl.onclick = () => navigateTo(`setView_${set.id}`);
                setEl.innerHTML = `
                    <img src="${set.images.logo}" class="h-12 w-auto object-contain flex-shrink-0" alt="${set.name} logo">
                    <div class="flex-grow">
                        <p class="font-bold">${set.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Released: ${set.releaseDate}</p>
                    </div>
                    <span class="text-xs font-bold">${set.printedTotal} Cards</span>
                `;
                setsContainer.appendChild(setEl);
            });
        }
        
        async function renderSetView(setId) {
            setViewContainer.innerHTML = `<div class="text-center p-8">Loading set...</div>`;
            const set = localSetDatabase.find(s => s.id === setId);
            if (!set) {
                setViewContainer.innerHTML = `<div class="text-center p-8 text-red-500">Set not found!</div>`;
                return;
            }
            
            setViewHeader.innerHTML = `<img src="${set.images.logo}" class="h-16 mx-auto mb-2" alt="${set.name} logo"><h1 class="text-2xl md:text-3xl font-black tracking-tighter">${set.name}</h1>`;
            
            try {
                const response = await fetch(`https://api.pokemontcg.io/v2/cards?q=set.id:${setId}`);
                const cardData = await response.json();
                const cards = cardData.data.sort((a,b) => parseInt(a.number) - parseInt(b.number));
                
                const collectedInSet = completionList.filter(c => c.set.id === setId).length;
                const percentage = (collectedInSet / set.printedTotal) * 100;
                setViewProgressText.textContent = `${collectedInSet}/${set.printedTotal} (${percentage.toFixed(1)}%)`;
                setViewProgressBar.style.width = `${percentage}%`;

                setViewContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 custom-scrollbar';
                setViewContainer.innerHTML = '';
                cards.forEach(card => setViewContainer.appendChild(createCardElement(card, displayCardAsGridTemplate(card))));

            } catch(e) {
                setViewContainer.innerHTML = `<div class="text-center p-8 text-red-500">Could not load cards for this set.</div>`;
                console.error("Failed to fetch set cards", e);
            }
        }

        // --- Authentication ---
        function setAuthMode(isRegister) {
            isRegistering = isRegister;
            loginError.textContent = '';
            loginTitle.textContent = isRegister ? 'CREATE ACCOUNT' : 'PLAYER LOGIN';
            loginSubmitBtn.textContent = isRegister ? '> REGISTER' : '> LOGIN';
            toggleAuthMode.innerHTML = isRegister ? 'Have an account? <span class="underline">Login</span>' : 'Need an account? <span class="underline">Register</span>';
            
            confirmPasswordInput.classList.toggle('hidden', !isRegister);
            confirmPasswordInput.required = isRegister;

            passwordInput.classList.toggle('mb-6', !isRegister);
            passwordInput.classList.toggle('mb-4', isRegister);
            if (!isRegister) {
                confirmPasswordInput.value = '';
            }
        }

        async function handleAuthForm(e) {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            loginError.textContent = '';
            
            if (isRegistering && password !== confirmPassword) {
                loginError.textContent = 'Passwords do not match.';
                return;
            }
            
            try {
                if (isRegistering) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) { 
                loginError.textContent = error.message.replace('Firebase: ', ''); 
            }
        }
        
        async function handleAuthState(user) {
            if (user) {
                currentUser = user;
                loginModal.classList.add('hidden');
                userDisplay.textContent = `PLAYER: ${user.email}`;
                logoutBtn.classList.remove('hidden');
                showListBtn.disabled = false;
                showSetsBtn.disabled = false;
                showWantsBtn.disabled = false;
                searchInput.disabled = true;
                searchInput.placeholder = "Loading database...";
                await syncLocalDatabases(); 
                searchInput.disabled = false;
                searchInput.placeholder = "Search Name or Pokédex Nr.";
                listenToUserData(user.uid);
                navigateTo('search'); 
                showStatus('Search for a card to begin!');
            } else {
                currentUser = null;
                completionList = [];
                wantsList = [];
                updateCollectionStats();
                if (unsubscribeFromCollection) unsubscribeFromCollection();
                if (unsubscribeFromWants) unsubscribeFromWants();
                loginModal.classList.remove('hidden');
                userDisplay.textContent = 'LOGGED OUT';
                logoutBtn.classList.add('hidden');
                showListBtn.disabled = true;
                showSetsBtn.disabled = true;
                showWantsBtn.disabled = true;
                searchInput.disabled = true;
                searchInput.placeholder = "Please log in...";
                resultsContainer.innerHTML = '';
                lastDisplayedCards = [];
            }
        }
        
        function applyDarkMode(isDark) {
            const sunIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
            const moonIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`;
            if (isDark) {
                document.documentElement.classList.add('dark');
                darkModeToggle.innerHTML = sunIcon;
            } else {
                document.documentElement.classList.remove('dark');
                darkModeToggle.innerHTML = moonIcon;
            }
        }
        function toggleDarkMode() {
            const isDarkMode = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', !isDarkMode);
            applyDarkMode(!isDarkMode);
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            searchInput.addEventListener('input', e => getAutocompleteSuggestions(e.target.value.trim()));
            searchInput.addEventListener('keyup', e => { if (e.key === 'Enter') { autocompleteResults.classList.add('hidden'); searchLocalDatabase(searchInput.value.trim()); } });
            document.addEventListener('click', e => { if (!e.target.closest('#autocomplete-container')) autocompleteResults.classList.add('hidden'); });
            closeModalButton.addEventListener('click', () => imageModal.classList.add('hidden'));
            document.addEventListener('keydown', e => e.key === 'Escape' && !imageModal.classList.contains('hidden') && imageModal.classList.add('hidden'));
            
            showListBtn.addEventListener('click', () => { if (currentUser) navigateTo('myList'); });
            showWantsBtn.addEventListener('click', () => { if (currentUser) navigateTo('wantsList'); });
            showSetsBtn.addEventListener('click', () => { if (currentUser) navigateTo('sets'); });
            backToSetsBtn.addEventListener('click', () => navigateTo('sets'));
            backToSearchBtnMyList.addEventListener('click', () => navigateTo('search'));
            backToSearchBtnSets.addEventListener('click', () => navigateTo('search'));
            backToSearchBtnWants.addEventListener('click', () => navigateTo('search'));

            calculateValueBtn.addEventListener('click', calculateCollectionValue);

            gridViewBtn.addEventListener('click', () => setActiveView('grid', 'search'));
            listViewBtn.addEventListener('click', () => setActiveView('list', 'search'));
            myListGridViewBtn.addEventListener('click', () => setActiveView('grid', 'myList'));
            myListListViewBtn.addEventListener('click', () => setActiveView('list', 'myList'));

            logoutBtn.addEventListener('click', () => signOut(auth));
            loginForm.addEventListener('submit', handleAuthForm);
            toggleAuthMode.addEventListener('click', () => setAuthMode(!isRegistering));
            darkModeToggle.addEventListener('click', toggleDarkMode);
            
            myListFilterControls.addEventListener('click', (e) => { const target = e.target.closest('.filter-btn'); if(target) setMyListFilter(target.dataset.type, target.dataset.value); });
            
            document.addEventListener('addToList', e => addToList(localCardDatabase[e.detail.cardId]));
            document.addEventListener('removeFromList', e => removeFromList(e.detail.cardId));
            document.addEventListener('addToWants', e => addToWants(localCardDatabase[e.detail.cardId]));
            document.addEventListener('removeFromWants', e => removeFromWants(e.detail.cardId));
        }
        
        // --- Initial Load ---
        function main() {
            setAuthMode(isRegistering); // Initialize the auth form state
            setActiveView('grid', 'search');
            setActiveView('grid', 'myList');
            createSortControls(searchSortControls, searchSort, () => displayCards(lastDisplayedCards));
            createSortControls(myListSortControlsContainer, myListSort, renderCompletionList);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('darkMode');
            applyDarkMode(savedTheme === 'true' || (savedTheme === null && prefersDark));
            
            onAuthStateChanged(auth, handleAuthState); 
            setupEventListeners();
        }

        main();
        async function uploadPokemonData() {
        console.log("Fetching local JSON file...");
        const response = await fetch('pokemon-tcg-db.json');
        const cards = await response.json();
        console.log(`Found ${cards.length} cards to upload.`);

        const batchSize = 500;
        for (let i = 0; i < cards.length; i += batchSize) {
            const batch = writeBatch(db);
            const chunk = cards.slice(i, i + batchSize);

            console.log(`Preparing batch ${Math.floor(i / batchSize) + 1}...`);
            chunk.forEach(card => {
                const docRef = doc(db, "cards", card.id);
                batch.set(docRef, card);
            });

            console.log("Uploading batch...");
            await batch.commit();
            console.log(`Batch ${Math.floor(i / batchSize) + 1} uploaded successfully.`);
        }
        console.log("All data uploaded to Firestore!");
        alert("All Pokémon card data has been successfully uploaded to your Firestore database in the 'cards' collection!");
    }

    // --- MAKE THE UPLOAD FUNCTION CALLABLE FROM CONSOLE ---
    window.uploadPokemonData = uploadPokemonData;
    console.log("Ready to upload. Log in, then run 'uploadPokemonData()' from the console.");
    </script>
    <style>
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; image-rendering: -webkit-optimize-contrast; image-rendering: pixelated; }
        body { font-family: 'Press Start 2P', cursive; background-color: #e0e0e0; color: #212121; transition: background-color 0.3s, color 0.3s; }
        html.dark body { background-color: #121212; color: #e0e0e0; }
        
        .game-box { background-color: white; border: 4px solid #212121; box-shadow: 6px 6px 0px #212121; transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s; }
        html.dark .game-box { background-color: #1e1e1e; border-color: #424242; box-shadow: none; }
        .game-box-thin { border: 2px solid #212121; box-shadow: 2px 2px 0px #212121; }
        html.dark .game-box-thin { border-color: #616161; box-shadow: none; }

        .game-btn { border: 3px solid #212121; box-shadow: 4px 4px 0px #212121; transition: all 0.1s ease-in-out; text-transform: uppercase; font-size: 14px; background-color: #fff; }
        .game-btn:hover { background-color: #f0f0f0; }
        .game-btn:active, .game-btn-active { box-shadow: 0px 0px 0px #212121; transform: translate(4px, 4px); background-color: #e0e0e0;}
        html.dark .game-btn { background-color: #333; border-color: #666; color: #f5f5f5; box-shadow: none; }
        html.dark .game-btn:hover { background-color: #444; }
        html.dark .game-btn:active, html.dark .game-btn-active { transform: translateY(2px); background-color: #222; }
        
        .game-btn:disabled { background-color: #bdbdbd; box-shadow: none; transform: none; cursor: not-allowed; opacity: 0.7; }
        html.dark .game-btn:disabled { background-color: #424242; }

        .game-btn-primary { background-color: #2979ff; color: white; }
        html.dark .game-btn-primary { background-color: #42a5f5; }
        .game-btn-danger { background-color: #D32F2F; color: white; }
        html.dark .game-btn-danger { background-color: #ef5350; }
        .game-btn-success { background-color: #00c853; color: white; }
        html.dark .game-btn-success { background-color: #66bb6a; }

        .game-input { background-color: white; border: 3px solid #212121; font-size: 16px; padding: 12px; width: 100%; transition: background-color 0.3s, border-color 0.3s; }
        html.dark .game-input { background-color: #2a2a2a; border-color: #616161; color: #f5f5f5; }
        .game-input:focus { outline: none; border-color: #2979ff; }
        html.dark .game-input:focus { border-color: #42a5f5; }
        
        .sort-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em; padding-right: 2.5rem; }
        html.dark .sort-select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23e0e0e0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); }
        
        .progress-container { border: 3px solid #212121; background-color: #e0e0e0; padding: 4px; height: 24px; }
        html.dark .progress-container { background-color: #424242; border-color: #616161; }
        .progress-bar-inner { background-color: #2979ff; transition: width 0.5s ease-out; height: 100%; }
        html.dark .progress-bar-inner { background-color: #42a5f5; }

        #toast-container { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; pointer-events: none; }
        .toast { background-color: #212121; color: white; padding: 20px; border-top: 4px solid #9e9e9e; animation: slide-up 0.3s ease-out, slide-down 0.3s ease-in 1.7s forwards; font-size: 14px; text-align: center; }
        html.dark .toast { background-color: #f5f5f5; color: #212121; border-top-color: #616161; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slide-down { from { transform: translateY(0); } to { transform: translateY(100%); } }
        
        .img-placeholder { display: inline-block; width: 100%; aspect-ratio: 245 / 342; background-color: #d1d5db; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        html.dark .img-placeholder { background-color: #374151; }
        .img-placeholder.w-20 { width: 5rem; aspect-ratio: 245 / 342; height: auto; }
        @keyframes pulse { 50% { opacity: .5; } }
        
        #autocomplete-container { position: relative; }
        #autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; background-color: white; border: 3px solid #212121; margin-top: -3px; max-height: 200px; overflow-y: auto; }
        html.dark #autocomplete-results { background-color: #2a2a2a; border-color: #616161; }
        .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 2px solid #e0e0e0; font-size: 14px; }
        html.dark .suggestion-item { border-bottom-color: #424242; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        html.dark .suggestion-item:hover { background-color: #424242; }

        #imageModal .modal-content-box {
            background-color: white; border: 4px solid #212121; box-shadow: 6px 6px 0px #212121;
            width: 90%; max-width: 90%; max-height: 95vh; overflow-y: auto;
        }
        html.dark #imageModal .modal-content-box { background-color: #1e1e1e; border-color: #424242; box-shadow: none; }
        
        #imageModal .modal-image-container { width: 100%; margin-bottom: 1rem; }
        #imageModal .modal-details-container { width: 100%; }

        @media (min-width: 768px) { 
            #imageModal .modal-content-box { max-width: 60rem; flex-direction: row; }
            #imageModal .modal-image-container { width: 41.666667%; margin-bottom: 0; }
            #imageModal .modal-details-container { width: 58.333333%; }
        }
        @media (min-width: 1024px) { #imageModal .modal-content-box { max-width: 70rem; } }

        .custom-scrollbar::-webkit-scrollbar { width: 12px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e0e0e0; }
        html.dark .custom-scrollbar::-webkit-scrollbar-track { background: #2a2a2a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #212121; border: 2px solid #e0e0e0; }
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #616161; border-color: #2a2a2a; }
        
        #modalDetailsContainer .text-red-700 { color: #D32F2F; text-shadow: 2px 2px #000; } 
        html.dark #modalDetailsContainer .text-red-500 { text-shadow: none; }
        
        .type-icon-text { font-size: 0.75rem; line-height: 1; color: white; text-align: center; font-family: sans-serif; font-weight: bold; text-shadow: 1px 1px #000; }
        
        #closeModal { position: absolute; top: 10px; right: 10px; width: 3rem; height: 3rem; font-size: 1.5rem; color: white; border: 3px solid #212121; z-index: 60; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        html.dark #closeModal { border-color: #f5f5f5; }

    </style>
</head>
<body class="antialiased">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70 dark:bg-opacity-80">
        <form id="loginForm" class="game-box p-8 text-center w-full max-w-sm">
            <h2 id="loginTitle" class="text-2xl font-bold mb-4">PLAYER LOGIN</h2>
            <p id="loginError" class="text-red-500 text-xs mb-4 h-4"></p>
            <input type="email" id="emailInput" class="game-input text-center mb-4" placeholder="Enter your email" required>
            <input type="password" id="passwordInput" class="game-input text-center mb-4" placeholder="Enter your password" required>
            <input type="password" id="confirmPasswordInput" class="game-input text-center mb-6 hidden" placeholder="Confirm your password" required>
            <button id="loginSubmitBtn" type="submit" class="w-full game-btn game-btn-primary py-3">> LOGIN</button>
            <p id="toggleAuthMode" class="text-xs text-gray-500 dark:text-gray-400 mt-6 cursor-pointer">Need an account? <span class="underline">Register</span></p>
        </form>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-8 relative z-10">
        <header class="relative text-center mb-4">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/98/International_Pok%C3%A9mon_logo.svg/1200px-International_Pok%C3%A9mon_logo.svg.png" alt="Pokemon Logo" class="h-16 sm:h-20 mx-auto mb-2">
            <h1 class="text-lg sm:text-xl md:text-2xl font-black tracking-tighter">Collection Tracker</h1>
            <button id="darkModeToggle" class="absolute top-1/2 right-0 -translate-y-1/2 game-btn p-2 sm:p-3 z-10"></button>
        </header>
        
        <nav class="flex flex-wrap justify-center gap-2 mb-10">
             <button id="showWantsBtn" class="game-btn py-3 px-6 text-sm flex-shrink-0" disabled>> WANTS</button>
             <button id="showSetsBtn" class="game-btn py-3 px-6 text-sm flex-shrink-0" disabled>> SETS</button>
             <button id="showListBtn" class="game-btn py-3 px-6 text-sm flex-shrink-0" disabled>> MY LIST</button>
        </nav>

        <!-- Main Search View -->
        <div id="searchView" class="">
            <div class="game-box p-4 md:p-6">
                <div class="mb-6 pb-6 border-b-4 border-dashed border-gray-300 dark:border-gray-700">
                    <div id="collectionStatsContainer" class="w-full flex-grow">
                        <div class="text-center text-gray-500 dark:text-gray-400">Loading stats...</div>
                    </div>
                </div>

                <div class="max-w-2xl mx-auto mb-4 flex flex-col md:flex-row gap-4 items-center">
                    <div id="autocomplete-container" class="flex-grow w-full relative">
                        <input type="text" id="searchInput" class="game-input text-center w-full" placeholder="Loading...">
                        <div id="autocomplete-results" class="hidden"></div>
                    </div>
                    <div class="flex gap-2 items-center">
                        <div id="searchSortControls" class="flex items-center"></div>
                        <button id="gridViewBtn" title="Grid View" class="game-btn p-3"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg></button>
                        <button id="listViewBtn" title="List View" class="game-btn p-3"><svg class="w-5 h-5" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z" clip-rule="evenodd"></path></svg></button>
                    </div>
                </div>
                <div id="statusDisplay" class="text-center text-gray-500 dark:text-gray-400 text-xs py-2"></div>
                <main id="results" class="gap-4"></main>
            </div>
        </div>
        
        <div id="wantsListPage" class="hidden">
             <header class="text-center mb-6 flex items-center justify-between">
                <button id="backToSearchBtnWants" class="game-btn py-2 px-4 text-sm">< SEARCH</button>
                <h1 class="text-3xl md:text-4xl font-black tracking-tighter">WANTS LIST</h1>
                <div class="w-20"></div> <!-- Spacer -->
            </header>
             <div class="game-box p-4 md:p-6">
                 <div id="wantsListContainer" class="space-y-4"></div>
             </div>
        </div>

        <div id="setsPage" class="hidden">
             <header class="text-center mb-6 flex items-center justify-between">
                <button id="backToSearchBtnSets" class="game-btn py-2 px-4 text-sm">< SEARCH</button>
                <h1 class="text-3xl md:text-4xl font-black tracking-tighter">SETS</h1>
                <div class="w-20"></div> <!-- Spacer -->
            </header>
             <div class="game-box p-4 md:p-6">
                 <div id="setsStatus" class="text-center text-gray-500 dark:text-gray-400 text-xs py-2"></div>
                 <div id="setsContainer" class="space-y-4"></div>
             </div>
        </div>
        
        <div id="setViewPage" class="hidden">
             <header class="text-center mb-6">
                <div class="flex items-center justify-between">
                    <button id="backToSetsBtn" class="game-btn py-2 px-4 text-sm">< SETS</button>
                    <div id="setViewHeader" class="flex-grow"></div>
                    <div class="w-20"></div>
                </div>
             </header>
             <div class="game-box p-4 md:p-6">
                <div class="flex justify-between items-center mb-4 text-xs">
                    <span class="font-semibold">SET PROGRESS</span>
                    <span id="setViewProgressText" class="font-bold">0/0</span>
                </div>
                <div class="progress-container mb-6"><div id="setViewProgressBar" class="progress-bar-inner" style="width: 0%"></div></div>
                <div id="setViewContainer"></div>
             </div>
        </div>


        <div id="myListFullPage" class="hidden">
            <header class="text-center mb-6"><div class="flex items-center justify-between"><button id="backToSearchBtnMyList" class="game-btn py-2 px-4 text-sm">< SEARCH</button><h1 class="text-3xl md:text-4xl font-black tracking-tighter">MY LIST</h1><div class="w-20"></div></div></header>
            <div class="game-box p-4 md:p-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 border-b-2 border-dashed border-gray-300 dark:border-gray-700 pb-4">
                    <div id="myListSortControls" class="flex items-center"></div>
                    <div class="flex justify-end gap-2 items-center">
                        <div id="totalValueDisplay" class="text-xs font-bold mr-4"></div>
                        <button id="calculateValueBtn" class="game-btn py-2 px-4 text-xs">CALC. VALUE</button>
                        <button id="myListGridViewBtn" title="Grid View" class="game-btn p-3"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg></button>
                        <button id="myListListViewBtn" title="List View" class="game-btn p-3"><svg class="w-5 h-5" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z" clip-rule="evenodd"></path></svg></button>
                    </div>
                </div>
                <div id="myListFilterControls" class="text-xs mb-4">
                    <div id="myListLetterFilters" class="flex flex-wrap gap-1 justify-center mb-2"></div>
                    <div id="myListRangeFilters" class="flex flex-wrap gap-1 justify-center"></div>
                </div>
                <div id="myListFullPageContainer" class="flex-grow overflow-y-auto pr-2 space-y-4 custom-scrollbar"></div>
            </div>
        </div>

        <footer class="text-center mt-4">
            <div class="flex items-center justify-center gap-4">
                   <p id="userDisplay" class="text-gray-500 dark:text-gray-400 text-xs"></p>
                   <button id="logoutBtn" class="hidden game-btn text-xs py-1 px-2 border-2 shadow-sm active:translate-y-0.5 active:shadow-none">> LOGOUT</button>
            </div>
        </footer>
    </div>
    
    <div id="imageModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black bg-opacity-70 dark:bg-opacity-80">
        <div class="relative w-11/12 modal-content-box p-4 sm:p-6 flex flex-col max-h-[95vh]">
            <div class="modal-image-container flex-shrink-0 flex justify-center items-start">
                <img id="modalImage" src="" alt="Pokémon Card Large View" class="w-full h-auto object-contain max-h-[85vh] rounded-lg">
            </div>
            <div id="modalDetailsContainer" class="modal-details-container flex-grow p-2 overflow-y-auto custom-scrollbar"></div>
            <button id="closeModal" class="absolute font-mono game-btn game-btn-danger">[X]</button>
        </div>
    </div>

    <div id="toast-container"></div>
</body>
</html>
