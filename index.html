<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon TCG Tracker - Retro UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <script type="module">
        // --- Firebase SDKs ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM References ---
        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('results');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalDetailsContainer = document.getElementById('modalDetailsContainer'); // NEW: Container for card details
        const closeModalButton = document.getElementById('closeModal');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        const showListBtn = document.getElementById('showListBtn');
        const myListPanel = document.getElementById('myListPanel');
        const panelOverlay = document.getElementById('panel-overlay');
        const myListContainer = document.getElementById('myListContainer');
        const toastContainer = document.getElementById('toast-container');
        const userDisplay = document.getElementById('userDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginError = document.getElementById('loginError');
        const loginTitle = document.getElementById('loginTitle');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const toggleAuthMode = document.getElementById('toggleAuthMode');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const statusDisplay = document.getElementById('statusDisplay');
        const closeListBtn = document.getElementById('closeListBtn');
        const sortControls = document.getElementById('sortControls');
        const filterControls = document.getElementById('filterControls');
        const letterFilters = document.getElementById('letter-filters');
        const rangeFilters = document.getElementById('range-filters');

        // --- State and Config ---
        const TOTAL_POKEMON_SPECIES = 1025; 
        let completionList = [];
        let currentUser = null;
        let unsubscribeFromCollection = null;
        let currentView = 'grid';
        let lastDisplayedCards = [];
        let localCardDatabase = {}; 
        let isRegistering = false;
        let currentSort = { field: 'pokedex', direction: 'asc' };
        let currentFilter = { type: 'all', value: null };

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqKvL31__K5UZo-iwjO7uN5zPN4t8aDn4",
            authDomain: "poke-c7d03.firebaseapp.com",
            projectId: "poke-c7d03",
            storageBucket: "poke-c7d03.appspot.com",
            messagingSenderId: "567243781113",
            appId: "1:567243781113:web:53c5a8e442b4967cdb4328"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;

        // --- UI Functions ---
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = message;
            toastContainer.innerHTML = ''; 
            toastContainer.appendChild(toast);
        }

        function toggleListPanel(open) {
            if (open) {
                if (!currentUser) {
                    showToast("Please log in to manage a list.");
                    return;
                }
                renderCompletionList();
                panelOverlay.classList.remove('hidden');
                myListPanel.classList.add('open');
            } else {
                panelOverlay.classList.add('hidden');
                myListPanel.classList.remove('open');
            }
        }
        
        function updateProgress() {
            const collectedPokedexNumbers = new Set(completionList.map(item => item.pokedex));
            const collectedCount = collectedPokedexNumbers.size;
            const percentage = (collectedCount / TOTAL_POKEMON_SPECIES) * 100;
            progressText.textContent = `${collectedCount}/${TOTAL_POKEMON_SPECIES} (${percentage.toFixed(1)}%)`;
            progressBar.style.width = `${percentage}%`;
        }

        function setActiveView(view) {
            currentView = view;
            gridViewBtn.classList.toggle('game-btn-active', view === 'grid');
            listViewBtn.classList.toggle('game-btn-active', view === 'list');
            displayCards(lastDisplayedCards);
        }
        
        function showStatus(message, isError = false) {
            statusDisplay.textContent = message;
            statusDisplay.classList.toggle('text-red-500', isError);
            if (!message && !isError) {
                setTimeout(() => { 
                    if(statusDisplay.textContent === message) statusDisplay.textContent = ''
                }, 3000);
            }
        }

        // --- Firestore Data Functions ---
        async function saveCollectionToFirestore() {
            if (!currentUser) return;
            try {
                const userDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "collection", "data");
                await setDoc(userDocRef, { list: completionList });
            } catch (error) {
                console.error("Error saving collection: ", error);
            }
        }

        function listenToCollection(userId) {
            if (unsubscribeFromCollection) unsubscribeFromCollection();
            const userDocRef = doc(db, "artifacts", appId, "users", userId, "collection", "data");
            
            unsubscribeFromCollection = onSnapshot(userDocRef, (docSnap) => {
                completionList = docSnap.exists() ? docSnap.data().list || [] : [];
                updateProgress();
                if (myListPanel.classList.contains('open')) renderCompletionList();
                displayCards(lastDisplayedCards);
            });
        }

        // --- Core App Logic ---
        async function addToList(card) {
            if (!currentUser) return;
            const pokedexNumber = card.nationalPokedexNumbers?.[0]; 
            if (!pokedexNumber) {
                showToast(`Cannot add ${card.name}: No Pokedex number found.`, true);
                return;
            }

            if (!completionList.some(item => item.id === card.id)) {
                const newEntry = {
                    id: card.id,
                    pokedex: pokedexNumber,
                    name: card.name,
                    image: `https://images.pokemontcg.io/${card.set.id}/${card.number}.png` 
                };
                completionList.push(newEntry);
                await saveCollectionToFirestore();
                showToast(`Added ${card.name} to your list!`);
            } else {
                showToast(`${card.name} is already in your list!`);
            }
        }

        async function removeFromList(cardId) {
            if (!currentUser) return;
            const removedItem = completionList.find(item => item.id === cardId);
            completionList = completionList.filter(item => item.id !== cardId);
            await saveCollectionToFirestore();
            if (removedItem) showToast(`${removedItem.name} was removed from the list.`);
        }
        
        function updateCardButton(card, isCollected, button) {
            button.disabled = isCollected;
            button.className = 'w-full mt-2 game-btn py-2 px-2 text-xs card-btn';
            if (currentView === 'list') {
                button.classList.add('sm:w-auto', 'sm:mt-0');
            }
            if (isCollected) {
                button.textContent = 'COLLECTED';
                button.classList.add('game-btn-success');
            } else {
                button.textContent = '> ADD';
                button.classList.add('game-btn-primary');
            }
        }

        // --- "My List" Sorting and Filtering ---
        function setSort(field, direction) {
            currentSort = { field, direction };
            renderCompletionList();
        }
        
        function setFilter(type, value) {
            currentFilter = { type, value };
            renderCompletionList();
        }

        function renderCompletionList() {
            myListContainer.innerHTML = '';
            
            const createButton = (parent, type, value, text, isTextSmall = false) => {
                const button = document.createElement('button');
                button.dataset.type = type;
                button.dataset.value = value;
                button.className = `filter-btn game-btn p-1 border-2 ${isTextSmall ? 'text-[8px]' : ''}`;
                button.textContent = text;
                parent.appendChild(button);
            };
            
            letterFilters.innerHTML = '';
            rangeFilters.innerHTML = '';

            createButton(letterFilters, 'all', 'all', 'ALL');

            if (completionList.length > 0) {
                const availableLetters = [...new Set(completionList.map(c => c.name[0].toUpperCase()))].sort();
                availableLetters.forEach(letter => createButton(letterFilters, 'letter', letter, letter));

                const getRange = num => `${Math.floor(num / 50) * 50 + 1}-${Math.floor(num / 50) * 50 + 50}`;
                const availableRanges = [...new Set(completionList.map(c => getRange(c.pokedex)))].sort((a,b) => parseInt(a) - parseInt(b));
                availableRanges.forEach(range => createButton(rangeFilters, 'range', range, range, true));
            }
            
            document.querySelectorAll('#sortControls button, #filterControls button').forEach(btn => btn.classList.remove('game-btn-active'));
            const activeSortBtn = document.querySelector(`.sort-btn[data-field='${currentSort.field}'][data-direction='${currentSort.direction}']`);
            if(activeSortBtn) activeSortBtn.classList.add('game-btn-active');
            
            const activeFilterBtn = document.querySelector(`.filter-btn[data-type='${currentFilter.type}'][data-value='${currentFilter.value}']`);
            if(activeFilterBtn) activeFilterBtn.classList.add('game-btn-active');

            let filteredList = completionList;
            if(currentFilter.type === 'letter'){
                filteredList = completionList.filter(item => item.name.toUpperCase().startsWith(currentFilter.value));
            } else if (currentFilter.type === 'range'){
                const [min, max] = currentFilter.value.split('-').map(Number);
                filteredList = completionList.filter(item => item.pokedex >= min && item.pokedex <= max);
            }

            const sortedList = [...filteredList].sort((a, b) => {
                if (currentSort.field === 'pokedex') {
                    return currentSort.direction === 'asc' ? a.pokedex - b.pokedex : b.pokedex - a.pokedex;
                }
                if (currentSort.field === 'name') {
                    return currentSort.direction === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                }
                return 0;
            });
            
            if (sortedList.length === 0) {
                myListContainer.innerHTML = `<div class="text-center p-4 text-gray-500">No cards match the filter...</div>`;
                return;
            }

            sortedList.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'flex items-center justify-between p-2 bg-white border-2 border-black';
                listItem.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${item.image}" alt="${item.name}" class="w-10 h-14 object-cover border-2 border-black">
                        <div>
                            <p class="font-bold text-sm">${item.name}</p>
                            <p class="pokedex-link text-xs text-gray-500 cursor-pointer hover:underline">#${String(item.pokedex).padStart(3, '0')}</p>
                        </div>
                    </div>
                    <button class="remove-btn text-red-500 hover:text-red-700 text-2xl">[X]</button>`;
                
                listItem.querySelector('.remove-btn').onclick = () => removeFromList(item.id);
                listItem.querySelector('.pokedex-link').onclick = () => {
                    toggleListPanel(false);
                    searchInput.value = item.pokedex;
                    searchLocalDatabase(String(item.pokedex));
                };

                myListContainer.appendChild(listItem);
            });
        }
        
        // --- Database Sync (Modified for single compiled JSON) ---
        async function syncLocalDatabase() {
            const storedDb = localStorage.getItem('pokemon-card-db');
            const dataUrl = 'https://raw.githubusercontent.com/codesbyabdi/poke/main/pokemon-tcg-db.json'; 

            if (storedDb) {
                try {
                    const parsedStoredDb = JSON.parse(storedDb);
                    if (Array.isArray(parsedStoredDb) && parsedStoredDb.length > 5000) { 
                        const tempDb = {};
                        parsedStoredDb.forEach(card => tempDb[card.id] = card);
                        localCardDatabase = tempDb;
                        showStatus('DATABASE LOADED FROM CACHE');
                        return;
                    } else {
                         localStorage.removeItem('pokemon-card-db');
                    }
                } catch (e) {
                    console.error("Error parsing cached DB, clearing:", e);
                    localStorage.removeItem('pokemon-card-db');
                }
            }
            
            try {
                showStatus('SYNCING DATABASE (first load might take a moment)...');
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`Network response not ok. Status: ${response.status} - ${response.statusText}`);
                }
                const dataArray = await response.json(); 
                
                const tempDb = {};
                dataArray.forEach(card => tempDb[card.id] = card);
                localCardDatabase = tempDb;

                localStorage.setItem('pokemon-card-db', JSON.stringify(dataArray)); 
                showStatus('DATABASE SYNCED. READY!');
            } catch (error) {
                showStatus(`DB SYNC FAILED: ${error.message}`, true);
                if (storedDb) {
                    try {
                        const dataArray = JSON.parse(storedDb);
                        const tempDb = {};
                        dataArray.forEach(card => tempDb[card.id] = card);
                        localCardDatabase = tempDb;
                        showStatus('Loaded from cache due to sync failure.', false);
                    } catch (e) {
                        console.error("Error parsing fallback cached DB:", e);
                        showStatus('No local cache found or it is corrupted.', true);
                    }
                }
            }
        }

        // --- Local Search ---
        function getAutocompleteSuggestions(query) {
            if (!query || Object.keys(localCardDatabase).length === 0) return displayAutocomplete([]);

            const lowerCaseQuery = query.toLowerCase();
            const suggestions = new Set(); 

            for (const cardId in localCardDatabase) {
                const card = localCardDatabase[cardId];
                if (card.name.toLowerCase().startsWith(lowerCaseQuery)) {
                    suggestions.add(card.name);
                }
                if (suggestions.size >= 100) break; 
            }
            displayAutocomplete(Array.from(suggestions).slice(0, 5));
        }

        function searchLocalDatabase(query) {
            resultsContainer.innerHTML = '';
            lastDisplayedCards = [];
            showStatus('SEARCHING...');
            
            if (!query) {
                showStatus('');
                return;
            }
            
            const isPokedexNumber = /^\d+$/.test(query);
            const lowerCaseQuery = query.toLowerCase();
            let results = [];

            for (const cardId in localCardDatabase) {
                const card = localCardDatabase[cardId];
                if (isPokedexNumber) {
                    const pokedexNumber = parseInt(query, 10);
                    if (Array.isArray(card.nationalPokedexNumbers) && card.nationalPokedexNumbers.includes(pokedexNumber)) {
                        results.push(card);
                    }
                } else {
                    if (card.name.toLowerCase().includes(lowerCaseQuery)) {
                        results.push(card);
                    }
                }
            }
            
            results.sort((a, b) => {
                const pokedexA = a.nationalPokedexNumbers?.[0] || Infinity;
                const pokedexB = b.nationalPokedexNumbers?.[0] || Infinity;

                if (pokedexA !== pokedexB) {
                    return pokedexA - pokedexB;
                }
                return a.name.localeCompare(b.name);
            });

            lastDisplayedCards = results;
            displayCards(lastDisplayedCards);

            if(lastDisplayedCards.length === 0) showStatus(`No cards found for "${query}".`, true);
            else showStatus(`${lastDisplayedCards.length} cards found.`);
        }

        // --- Display Functions ---
        function displayAutocomplete(names) {
            autocompleteResults.innerHTML = '';
            if (names.length === 0) return autocompleteResults.classList.add('hidden');
            names.forEach(name => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = name;
                item.onclick = () => {
                    searchInput.value = name;
                    autocompleteResults.classList.add('hidden');
                    searchLocalDatabase(name);
                };
                autocompleteResults.appendChild(item);
            });
            autocompleteResults.classList.remove('hidden');
        }

        function displayCards(cards) {
            resultsContainer.innerHTML = '';
            if (cards.length === 0) return;
            if (currentView === 'grid') {
                resultsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6';
                cards.forEach(displayCardAsGrid);
            } else {
                resultsContainer.className = 'space-y-4';
                cards.forEach(displayCardAsList);
            }
        }
        
        // NEW FUNCTION: showCardDetailsModal
        function showCardDetailsModal(card) {
            const largeImageUrl = `https://images.pokemontcg.io/${card.set.id}/${card.number}_hires.png`;
            modalImage.src = largeImageUrl;
            modalDetailsContainer.innerHTML = ''; // Clear previous details

            // Helper for detail rows
            const addDetailRow = (label, value) => {
                if (value === undefined || value === null || value === '' || (Array.isArray(value) && value.length === 0)) return '';
                return `
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-bold text-gray-800 detail-label">${label}:</span>
                        <span class="text-gray-700 detail-value">${value}</span>
                    </div>
                `;
            };

            // Helper for ability/attack blocks
            const addSection = (title, contentHtml) => {
                if (!contentHtml.trim()) return '';
                return `
                    <div class="mb-4 pt-2 border-t border-gray-300">
                        <h3 class="text-md font-bold mb-2 uppercase text-blue-800">${title}</h3>
                        ${contentHtml}
                    </div>
                `;
            };

            let detailsHtml = `
                <h2 class="text-2xl font-black mb-3 text-red-700 uppercase">${card.name}</h2>
                <div class="text-lg font-bold mb-2">
                    ${card.nationalPokedexNumbers ? `#${String(card.nationalPokedexNumbers[0]).padStart(3, '0')} ` : ''}
                    ${card.supertype || ''} ${card.subtype ? `— ${card.subtype}` : ''}
                </div>
                ${addDetailRow('HP', card.hp)}
                ${card.types ? addDetailRow('Type', card.types.join(', ')) : ''}
            `;

            // Abilities
            if (card.abilities && card.abilities.length > 0) {
                let abilitiesHtml = card.abilities.map(ability => `
                    <div class="mb-2">
                        <p class="font-semibold text-gray-900">${ability.name}</p>
                        <p class="text-sm text-gray-600">${ability.text}</p>
                    </div>
                `).join('');
                detailsHtml += addSection('Abilities', abilitiesHtml);
            }

            // Attacks
            if (card.attacks && card.attacks.length > 0) {
                let attacksHtml = card.attacks.map(attack => `
                    <div class="mb-2">
                        <p class="font-semibold text-gray-900">${attack.name} <span class="text-sm font-normal text-blue-600">(${attack.cost ? attack.cost.join(', ') : 'No Cost'})</span></p>
                        ${attack.damage ? `<p class="text-sm">Damage: ${attack.damage}</p>` : ''}
                        <p class="text-sm text-gray-600">${attack.text}</p>
                    </div>
                `).join('');
                detailsHtml += addSection('Attacks', attacksHtml);
            }

            // Weaknesses, Resistances, Retreat Cost
            let statsHtml = '';
            if (card.weaknesses && card.weaknesses.length > 0) {
                statsHtml += `<p class="text-sm text-gray-700">Weakness: ${card.weaknesses.map(w => `${w.type} ${w.value}`).join(', ')}</p>`;
            }
            if (card.resistances && card.resistances.length > 0) {
                statsHtml += `<p class="text-sm text-gray-700">Resistance: ${card.resistances.map(r => `${r.type} ${r.value}`).join(', ')}</p>`;
            }
            if (card.retreatCost && card.retreatCost.length > 0) {
                statsHtml += `<p class="text-sm text-gray-700">Retreat Cost: ${card.retreatCost.join(', ')}</p>`;
            }
            detailsHtml += addSection('Stats', statsHtml);

            // General Info
            detailsHtml += addSection('Card Info', `
                ${addDetailRow('Set', card.set?.name || 'N/A')}
                ${addDetailRow('Rarity', card.rarity || 'N/A')}
                ${addDetailRow('Artist', card.artist || 'N/A')}
                ${addDetailRow('Release Date', card.set?.releaseDate || 'N/A')}
            `);

            // Flavor Text
            if (card.flavorText) {
                detailsHtml += addSection('Flavor Text', `<p class="text-sm italic text-gray-600">"${card.flavorText}"</p>`);
            }
            
            modalDetailsContainer.innerHTML = detailsHtml; // Set the generated HTML
            imageModal.classList.remove('hidden'); // Show the modal
        }


        function createCardElement(card, template) {
            const cardElement = document.createElement('div');
            cardElement.innerHTML = template;
            const isCollected = currentUser && completionList.some(item => item.id === card.id);
            const img = cardElement.querySelector('.card-image');
            const imageContainer = cardElement.querySelector('.img-placeholder');
            const smallImageUrl = `https://images.pokemontcg.io/${card.set.id}/${card.number}.png`;
            // Removed largeImageUrl variable, now passed directly to showCardDetailsModal

            if(img && imageContainer) {
                const imageLoader = new Image();
                imageLoader.src = smallImageUrl;
                imageLoader.onload = () => {
                    img.src = imageLoader.src;
                    img.classList.remove('opacity-0');
                    imageContainer.classList.remove('img-placeholder');
                };
                imageLoader.onerror = () => {
                    imageContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-xs p-2">Image missing</div>`;
                };
            }
            
            if (img) {
                // MODIFIED: Call showCardDetailsModal with the full card object
                img.addEventListener('click', () => {
                    showCardDetailsModal(card);
                });
            }

            const addButton = cardElement.querySelector('.card-btn');
            if (card.nationalPokedexNumbers && addButton) {
                updateCardButton(card, isCollected, addButton);
                addButton.onclick = () => addToList(card);
            } else if (addButton) {
                addButton.remove();
            }
            return cardElement.firstElementChild;
        }

        function displayCardAsGrid(card) {
            const template = `<div class="text-center"><div class="img-placeholder"><img alt="${card.name}" class="card-image w-full border-4 border-black cursor-pointer opacity-0" loading="lazy"></div><div class="mt-2 text-xs"><p class="font-bold truncate">${card.name}</p></div><button data-card-id="${card.id}" class="card-btn"></button></div>`;
            resultsContainer.appendChild(createCardElement(card, template));
        }
        
        function displayCardAsList(card) {
            const template = `<div class="game-box p-3 flex flex-col sm:flex-row items-center gap-4"><div class="img-placeholder w-20 h-28 flex-shrink-0"><img alt="${card.name}" class="card-image w-20 h-28 object-cover border-2 border-black cursor-pointer opacity-0" loading="lazy"></div><div class="flex-grow text-center sm:text-left"><p class="font-bold text-base">${card.name}</p><p class="text-xs text-gray-500">#${String(card.nationalPokedexNumbers?.[0] || 'N/A').padStart(3, '0')}</p></div><button data-card-id="${card.id}" class="card-btn"></button></div>`;
            resultsContainer.appendChild(createCardElement(card, template));
        }

        // --- Authentication ---
        function setAuthMode(isRegister) {
            isRegistering = isRegister;
            loginError.textContent = '';
            loginTitle.textContent = isRegister ? 'CREATE ACCOUNT' : 'PLAYER LOGIN';
            loginSubmitBtn.textContent = isRegister ? '> REGISTER' : '> LOGIN';
            toggleAuthMode.innerHTML = isRegister ? 'Have an account? <span class="underline">Login</span>' : 'Need an account? <span class="underline">Register</span>';
        }

        async function handleAuthForm(e) {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.textContent = '';
            try {
                if (isRegistering) await createUserWithEmailAndPassword(auth, email, password);
                else await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = error.message.replace('Firebase: ', '');
            }
        }
        
        async function handleAuthState(user) {
            if (user) {
                currentUser = user;
                loginModal.classList.add('hidden');
                userDisplay.textContent = `PLAYER: ${user.email}`;
                logoutBtn.classList.remove('hidden');
                showListBtn.disabled = false;
                await syncLocalDatabase(); 
                searchInput.disabled = false;
                searchInput.placeholder = "Search Name or Pokédex Nr.";
                listenToCollection(user.uid);
                searchLocalDatabase('Pikachu'); 
            } else {
                currentUser = null;
                completionList = [];
                updateProgress();
                if (unsubscribeFromCollection) unsubscribeFromCollection();
                loginModal.classList.remove('hidden');
                userDisplay.textContent = 'LOGGED OUT';
                logoutBtn.classList.add('hidden');
                showListBtn.disabled = true;
                searchInput.disabled = true;
                searchInput.placeholder = "Please log in...";
                resultsContainer.innerHTML = '';
                lastDisplayedCards = [];
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            searchInput.addEventListener('input', e => getAutocompleteSuggestions(e.target.value.trim()));
            searchInput.addEventListener('keyup', e => {
                if (e.key === 'Enter') {
                    autocompleteResults.classList.add('hidden');
                    searchLocalDatabase(searchInput.value.trim());
                }
            });
            document.addEventListener('click', e => {
                if (!e.target.closest('#autocomplete-container')) autocompleteResults.classList.add('hidden');
            });
            closeModalButton.addEventListener('click', () => imageModal.classList.add('hidden'));
            document.addEventListener('keydown', e => e.key === 'Escape' && !imageModal.classList.contains('hidden') && imageModal.classList.add('hidden'));
            showListBtn.addEventListener('click', () => toggleListPanel(true));
            panelOverlay.addEventListener('click', () => toggleListPanel(false));
            closeListBtn.addEventListener('click', () => toggleListPanel(false));
            gridViewBtn.addEventListener('click', () => setActiveView('grid'));
            listViewBtn.addEventListener('click', () => setActiveView('list'));
            logoutBtn.addEventListener('click', () => signOut(auth));
            loginForm.addEventListener('submit', handleAuthForm);
            toggleAuthMode.addEventListener('click', () => setAuthMode(!isRegistering));
            
            sortControls.addEventListener('click', (e) => {
                const target = e.target.closest('.sort-btn');
                if(target){
                    setSort(target.dataset.field, target.dataset.direction);
                }
            });
            filterControls.addEventListener('click', (e) => {
                const target = e.target.closest('.filter-btn');
                if(target){
                    setFilter(target.dataset.type, target.dataset.value);
                }
            });
        }
        
        // --- Initial Load ---
        function main() {
            setActiveView('grid');
            onAuthStateChanged(auth, handleAuthState); 
            setupEventListeners();
        }

        main();
    </script>
    <style>
        html {
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            image-rendering: -webkit-optimize-contrast; image-rendering: pixelated;
        }
        body { font-family: 'Press Start 2P', cursive; background-color: #e0e0e0; color: #212121; }
        .game-box { background-color: white; border: 4px solid #212121; box-shadow: 6px 6px 0px #212121; }
        .game-btn { border: 3px solid #212121; box-shadow: 4px 4px 0px #212121; transition: all 0.1s ease-in-out; text-transform: uppercase; font-size: 14px; background-color: #fff; }
        .game-btn:hover { background-color: #f0f0f0; }
        .game-btn:active, .game-btn-active { box-shadow: 0px 0px 0px #212121; transform: translate(4px, 4px); background-color: #e0e0e0;}
        .game-btn:disabled { background-color: #bdbdbd; box-shadow: none; transform: none; cursor: not-allowed; opacity: 0.7; }
        .game-btn-primary { background-color: #2979ff; color: white; }
        .game-btn-primary:hover:not(:disabled) { background-color: #2962ff; }
        .game-btn-success { background-color: #00c853; color: white; }
        .game-btn-success:hover:not(:disabled) { background-color: #00bfa5; }
        .game-input { background-color: white; border: 3px solid #212121; font-size: 16px; padding: 12px; width: 100%; }
        .game-input:focus { outline: none; border-color: #2979ff; }
        .progress-container { border: 3px solid #212121; background-color: #e0e0e0; padding: 4px; }
        .progress-bar-inner { background-color: #2979ff; transition: width 0.5s ease-out; height: 16px; }
        #toast-container { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; pointer-events: none; }
        .toast { background-color: #212121; color: white; padding: 20px; border-top: 4px solid #9e9e9e; animation: slide-up 0.3s ease-out, slide-down 0.3s ease-in 2.7s forwards; font-size: 14px; text-align: center; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slide-down { from { transform: translateY(0); } to { transform: translateY(100%); } }
        #myListPanel { border-left: 4px solid #212121; background-color: #f0f0f0; transition: transform 0.4s ease-in-out; transform: translateX(100%); }
        #myListPanel.open { transform: translateX(0); }
        #panel-overlay { transition: opacity 0.4s ease-in-out; backdrop-filter: blur(2px); }
        .img-placeholder {
            display: inline-block;
            width: 100%;
            aspect-ratio: 245 / 342;
            background-color: #d1d5db;
            border: 4px solid #212121;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .img-placeholder.w-20 { width: 5rem; aspect-ratio: 245 / 342; height: auto; }
        @keyframes pulse { 50% { opacity: .5; } }
        #autocomplete-container { position: relative; }
        #autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; background-color: white; border: 3px solid #212121; margin-top: -3px; max-height: 200px; overflow-y: auto; }
        .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 2px solid #e0e0e0; font-size: 14px; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f0f0f0; }

        /* NEW: Modal Specific Styles */
        #imageModal .modal-content-box { /* Apply game-box styles to inner modal content */
            background-color: white;
            border: 4px solid #212121;
            box-shadow: 6px 6px 0px #212121;
        }

        #imageModal .detail-label {
            color: #4A5568; /* Tailwind gray-700 equivalent for labels */
        }
        #imageModal .detail-value {
            color: #2D3748; /* Tailwind gray-800 equivalent for values */
        }
        #imageModal h2 {
            color: #DC2626; /* Tailwind red-700 equivalent */
        }
        #imageModal h3 {
            color: #1D4ED8; /* Tailwind blue-800 equivalent */
        }
        #imageModal .text-red-700 {
            color: #DC2626;
        }
        #imageModal .text-blue-600 {
            color: #2563EB;
        }
        #imageModal .text-gray-900 {
            color: #1A202C;
        }
        #imageModal .text-gray-600 {
            color: #4A5568;
        }
        /* Responsive adjustments for modal content */
        @media (min-width: 640px) { /* sm breakpoint */
            #imageModal .modal-content-box {
                max-width: 90%; /* Adjust max width on larger screens */
            }
        }
        @media (min-width: 768px) { /* md breakpoint */
            #imageModal .modal-content-box {
                max-width: 80%;
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            #imageModal .modal-content-box {
                max-width: 60%;
            }
        }
    </style>
</head>
<body class="antialiased">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70">
        <form id="loginForm" class="game-box p-8 text-center w-full max-w-sm">
            <h2 id="loginTitle" class="text-2xl font-bold mb-4">PLAYER LOGIN</h2>
            <p id="loginError" class="text-red-500 text-xs mb-4 h-4"></p>
            <input type="email" id="emailInput" class="game-input text-center mb-4" placeholder="Enter your email" required>
            <input type="password" id="passwordInput" class="game-input text-center mb-6" placeholder="Enter your password" required>
            <button id="loginSubmitBtn" type="submit" class="w-full game-btn game-btn-primary py-3">> LOGIN</button>
            <p id="toggleAuthMode" class="text-xs text-gray-500 mt-6 cursor-pointer">Need an account? <span class="underline">Register</span></p>
        </form>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-8 relative z-10">
        <header class="text-center mb-10 p-4"><h1 class="text-3xl md:text-4xl font-black mb-2 tracking-tighter">POKéMON TCG TRACKER</h1></header>

        <div class="game-box p-4 md:p-6">
            <div class="mb-6 pb-6 border-b-4 border-dashed border-gray-300">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-6">
                    <div class="w-full sm:w-2/3">
                        <div class="flex justify-between items-center mb-2 text-xs">
                            <span class="font-semibold">PROGRESS</span>
                            <span id="progressText" class="font-bold">0/1025</span>
                        </div>
                        <div class="progress-container"><div id="progressBar" class="progress-bar-inner" style="width: 0%"></div></div>
                    </div>
                    <button id="showListBtn" class="w-full sm:w-auto game-btn py-3 px-6 text-sm" disabled>> MY LIST</button>
                </div>
            </div>

            <div id="searchView">
                <div class="max-w-xl mx-auto mb-4 flex flex-col sm:flex-row gap-4 items-center">
                    <div id="autocomplete-container" class="flex-grow w-full">
                        <input type="text" id="searchInput" class="game-input text-center w-full" placeholder="Loading...">
                        <div id="autocomplete-results" class="hidden"></div>
                    </div>
                    <div class="flex gap-2">
                        <button id="gridViewBtn" title="Grid View" class="game-btn p-3">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                        </button>
                        <button id="listViewBtn" title="List View" class="game-btn p-3">
                           <svg class="w-5 h-5" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="statusDisplay" class="text-center text-gray-500 text-xs py-2"></div>
                <main id="results" class="gap-6"></main>
            </div>
        </div>

        <footer class="text-center mt-4">
            <div class="flex items-center justify-center gap-4">
                   <p id="userDisplay" class="text-gray-500 text-xs"></p>
                   <button id="logoutBtn" class="hidden game-btn text-xs py-1 px-2 border-2 shadow-sm active:translate-y-0.5 active:shadow-none">> LOGOUT</button>
            </div>
        </footer>
    </div>
    
    <!-- MODIFIED: Image/Details Modal -->
    <div id="imageModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-70 overflow-y-auto">
        <div class="relative w-full max-w-lg md:max-w-3xl lg:max-w-4xl modal-content-box p-4 flex flex-col md:flex-row gap-4 overflow-y-auto max-h-[90vh]">
            <!-- Card Image Column -->
            <div class="flex-shrink-0 flex justify-center items-start md:w-1/2">
                <img id="modalImage" src="" alt="Pokémon Card Large View" class="w-full h-auto object-contain max-h-[70vh] border-2 border-black rounded-lg shadow-lg">
            </div>

            <!-- Card Details Column -->
            <div id="modalDetailsContainer" class="flex-grow text-sm md:w-1/2 p-2 overflow-y-auto custom-scrollbar">
                <!-- Details will be dynamically inserted here -->
                <p>Loading card details...</p> 
            </div>

            <button id="closeModal" class="absolute -top-4 -right-4 bg-red-500 text-white border-2 border-black h-10 w-10 font-mono text-2xl flex items-center justify-center hover:bg-red-600 rounded-full shadow-lg">[X]</button>
        </div>
    </div>

    <div id="panel-overlay" class="fixed inset-0 bg-black/30 z-30 hidden"></div>
    <aside id="myListPanel" class="fixed top-0 right-0 h-full w-full max-w-md p-6 z-40 flex flex-col">
        <div class="flex-shrink-0">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">MY LIST</h2>
                <button id="closeListBtn" class="text-gray-600 hover:text-black transition-colors text-3xl">[X]</button>
            </div>
            <div id="sortControls" class="grid grid-cols-2 gap-2 text-xs border-y-2 border-black py-2 mb-4">
                <div class="flex items-center gap-2">
                    <span class="font-bold">#</span>
                    <button data-field="pokedex" data-direction="asc" title="Sort by Number Ascending" class="sort-btn game-btn p-1 border-2">▲</button>
                    <button data-field="pokedex" data-direction="desc" title="Sort by Number Descending" class="sort-btn game-btn p-1 border-2">▼</button>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold">NAME</span>
                    <button data-field="name" data-direction="asc" title="Sort by Name Ascending" class="sort-btn game-btn p-1 border-2">▲</button>
                    <button data-field="name" data-direction="desc" title="Sort by Name Descending" class="sort-btn game-btn p-1 border-2">▼</button>
                </div>
            </div>
             <div id="filterControls" class="text-xs mb-4">
                <div id="letter-filters" class="flex flex-wrap gap-1 justify-center mb-2">
                    <!-- Letter filters will be dynamically generated here -->
                </div>
                <div id="range-filters" class="flex flex-wrap gap-1 justify-center">
                    <!-- Range filters will be dynamically generated here -->
                </div>
            </div>
        </div>
        <div id="myListContainer" class="flex-grow overflow-y-auto pr-2 space-y-4"></div>
    </aside>

    <div id="toast-container"></div>
</body>
</html>
