<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon TCG Tracker - Retro UI</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Press Start 2P -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- Firebase JS SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This configuration will be populated by the environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM References ---
        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('results');
        const loader = document.getElementById('loader');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModalButton = document.getElementById('closeModal');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        const showListBtn = document.getElementById('showListBtn');
        const myListPanel = document.getElementById('myListPanel');
        const panelOverlay = document.getElementById('panel-overlay');
        const myListContainer = document.getElementById('myListContainer');
        const toastContainer = document.getElementById('toast-container');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // --- State ---
        const API_BASE_URL = 'https://api.pokemontcg.io/v2/cards';
        const API_KEY = '5a26cb39-be13-4633-a80b-ce7256a17fe9'; // Your API Key
        const TOTAL_POKEMON = 1025;
        let completionList = [];
        let currentUser = null;
        let unsubscribeFromCollection = null;
        let searchTimeout; // For debouncing search input

        // --- Toast Notifications ---
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = message;
            toastContainer.innerHTML = ''; 
            toastContainer.appendChild(toast);
        }

        // --- UI Functions ---
        function toggleListPanel(open) {
            if (open) {
                renderCompletionList();
                panelOverlay.classList.remove('hidden');
                myListPanel.classList.add('open');
            } else {
                panelOverlay.classList.add('hidden');
                myListPanel.classList.remove('open');
            }
        }
        
        function updateProgress() {
            const collectedCount = completionList.length;
            const percentage = (collectedCount / TOTAL_POKEMON) * 100;
            progressText.textContent = `${collectedCount}/${TOTAL_POKEMON} (${percentage.toFixed(1)}%)`;
            progressBar.style.width = `${percentage}%`;
        }

        // --- Firestore Data Functions ---
        async function saveCollectionToFirestore() {
            if (!currentUser) return;
            try {
                const userDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "collection", "data");
                await setDoc(userDocRef, { list: completionList });
            } catch (error) {
                console.error("Error saving collection: ", error);
                showToast("Error: Could not save progress.");
            }
        }

        function listenToCollection(userId) {
            if (unsubscribeFromCollection) unsubscribeFromCollection();
            const userDocRef = doc(db, "artifacts", appId, "users", userId, "collection", "data");
            
            unsubscribeFromCollection = onSnapshot(userDocRef, (docSnap) => {
                completionList = docSnap.exists() ? docSnap.data().list || [] : [];
                updateProgress();
                if (myListPanel.classList.contains('open')) renderCompletionList();
                
                // If there are cards on screen, update their buttons without a full search
                const displayedCardButtons = document.querySelectorAll('.card-btn[data-pokedex]');
                if (displayedCardButtons.length > 0) {
                    displayedCardButtons.forEach(button => {
                        const pokedexNumber = parseInt(button.dataset.pokedex, 10);
                        const isCollected = completionList.some(item => item.pokedex === pokedexNumber);
                        updateCardButton(pokedexNumber, isCollected);
                    });
                }
            }, (error) => {
                console.error("Error listening to collection:", error);
                showToast("Error: Connection lost.");
            });
        }

        // --- Core App Logic ---
        async function addToList(card) {
            const pokedexNumber = card.nationalPokedexNumbers?.[0];
            if (!pokedexNumber || !currentUser) return;

            if (!completionList.some(item => item.pokedex === pokedexNumber)) {
                const newEntry = {
                    pokedex: pokedexNumber,
                    name: card.name.split('-')[0].trim(),
                    image: card.images.small
                };
                completionList.push(newEntry);
                await saveCollectionToFirestore();
                showToast(`Registered ${newEntry.name} to the list!`);
            }
        }

        async function removeFromList(pokedexNumber) {
            if (!currentUser) return;
            const removedItem = completionList.find(item => item.pokedex === pokedexNumber);
            completionList = completionList.filter(item => item.pokedex !== pokedexNumber);
            await saveCollectionToFirestore();
            if (removedItem) showToast(`${removedItem.name} was removed from the list.`);
        }
        
        function updateCardButton(pokedexNumber, isCollected) {
             const button = document.querySelector(`.card-btn[data-pokedex='${pokedexNumber}']`);
             if (button) {
                button.disabled = isCollected;
                button.className = 'w-full mt-2 game-btn py-2 px-2 text-xs card-btn';
                if (isCollected) {
                    button.textContent = 'COLLECTED';
                    button.classList.add('game-btn-success');
                } else {
                    button.textContent = '> ADD';
                    button.classList.add('game-btn-primary');
                }
             }
        }

        function renderCompletionList() {
            myListContainer.innerHTML = '';
            if (completionList.length === 0) {
                myListContainer.innerHTML = `<div class="text-center p-4 text-gray-500">Your list is empty...</div>`;
                return;
            }
            const sortedList = [...completionList].sort((a, b) => a.pokedex - b.pokedex);
            sortedList.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'flex items-center justify-between p-2 bg-white border-2 border-black';
                listItem.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${item.image}" alt="${item.name}" class="w-10 h-14 object-cover border-2 border-black">
                        <div>
                            <p class="font-bold text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">#${String(item.pokedex).padStart(3, '0')}</p>
                        </div>
                    </div>
                    <button class="remove-btn text-red-500 hover:text-red-700 text-2xl">[X]</button>`;
                listItem.querySelector('.remove-btn').onclick = () => removeFromList(item.pokedex);
                myListContainer.appendChild(listItem);
            });
        }
        
        function showMessage(msg) {
            resultsContainer.innerHTML = `<div class="col-span-full text-center py-10"><p class="text-gray-500">${msg}</p></div>`;
        }

        function toggleLoader(isLoading) {
            loader.style.display = isLoading ? 'block' : 'none';
            if (isLoading) resultsContainer.innerHTML = '';
        }
        
        // --- API & Search Functions ---
        async function searchCards(query, showLoader = true) {
            if (!query) {
                resultsContainer.innerHTML = ''; // Clear results if query is empty
                return;
            }
            if (showLoader) toggleLoader(true);

            const isPokedexNumber = /^\d+$/.test(query);
            const apiQuery = isPokedexNumber ? `nationalPokedexNumbers:${query}` : `name:"${query}*"`;
            try {
                const response = await fetch(`${API_BASE_URL}?q=${apiQuery}&orderBy=set.releaseDate&pageSize=18`, {
                    headers: {
                        'X-Api-Key': API_KEY
                    }
                });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const data = await response.json();
                displayCards(data.data || []);
            } catch (error) {
                console.error("API Search Error:", error);
                showMessage('An error occurred. Try again.');
            } finally {
                if (showLoader) toggleLoader(false);
            }
        }

        function displayCards(cards) {
            resultsContainer.innerHTML = ''; // Clear previous results or placeholders
            if (cards.length === 0) {
                showMessage(`No cards found for "${searchInput.value.trim()}".`);
                return;
            }
            
            cards.forEach((card) => {
                const pokedexNumber = card.nationalPokedexNumbers?.[0];
                const isCollected = pokedexNumber ? completionList.some(item => item.pokedex === pokedexNumber) : false;
                
                const cardElement = document.createElement('div');
                cardElement.className = 'text-center';
                
                // Image container with placeholder
                const imageContainer = document.createElement('div');
                imageContainer.className = 'img-placeholder';

                const img = document.createElement('img');
                img.alt = card.name;
                img.className = 'w-full border-4 border-black cursor-pointer opacity-0 transition-opacity duration-500'; // Start transparent
                img.loading = 'lazy'; // Still good practice

                imageContainer.appendChild(img);

                // Progressive image loading
                const imageLoader = new Image();
                imageLoader.src = card.images.small;
                imageLoader.onload = () => {
                    img.src = imageLoader.src;
                    img.classList.remove('opacity-0'); // Fade in
                    imageContainer.classList.remove('img-placeholder'); // Remove placeholder background
                };
                imageLoader.onerror = () => {
                     // Handle image loading errors if needed
                    imageContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-xs text-center p-2">Image not found</div>`;
                };

                const cardInfo = document.createElement('div');
                cardInfo.className = 'mt-2 text-xs';
                cardInfo.innerHTML = `<p class="font-bold truncate">${card.name}</p>`;

                cardElement.appendChild(imageContainer);
                cardElement.appendChild(cardInfo);
                
                if (pokedexNumber) {
                    const addButton = document.createElement('button');
                    addButton.dataset.pokedex = pokedexNumber;
                    cardElement.appendChild(addButton);
                    updateCardButton(pokedexNumber, isCollected);
                    addButton.onclick = () => addToList(card);
                }
                
                img.addEventListener('click', () => {
                    modalImage.src = card.images.large;
                    imageModal.classList.remove('hidden');
                });

                resultsContainer.appendChild(cardElement);
            });
        }
        
        // --- Authentication and Initialization ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                userIdDisplay.textContent = `USER ID: ${user.uid}`;
                listenToCollection(user.uid);
                // Perform initial search only if results are empty
                if (!resultsContainer.hasChildNodes()) {
                    searchInput.value = 'Pikachu';
                    searchCards(searchInput.value);
                }
            } else {
                currentUser = null;
                completionList = [];
                updateProgress();
                userIdDisplay.textContent = 'USER ID: Not signed in';
            }
        });
        
        // Debounce function to limit API calls
        function debounceSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchCards(query, true);
            }, 400); // Wait 400ms after user stops typing
        }

        // --- Event Listeners ---
        searchInput.addEventListener('input', e => debounceSearch(e.target.value.trim()));
        closeModalButton.addEventListener('click', () => imageModal.classList.add('hidden'));
        document.addEventListener('keydown', e => e.key === 'Escape' && !imageModal.classList.contains('hidden') && imageModal.classList.add('hidden'));
        showListBtn.addEventListener('click', () => toggleListPanel(true));
        panelOverlay.addEventListener('click', () => toggleListPanel(false));

        // --- Initial Load ---
        async function main() {
             await signInAnonymously(auth).catch(error => {
                console.error("Anonymous sign-in failed:", error);
                showToast("Error: Could not connect.");
            });
        }

        main();
    </script>
    <style>
        html {
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            image-rendering: -webkit-optimize-contrast; image-rendering: pixelated;
        }
        body { font-family: 'Press Start 2P', cursive; background-color: #e0e0e0; color: #212121; }
        .game-box { background-color: white; border: 4px solid #212121; box-shadow: 6px 6px 0px #212121; }
        .game-btn { border: 3px solid #212121; box-shadow: 4px 4px 0px #212121; transition: all 0.1s ease-in-out; text-transform: uppercase; font-size: 14px; }
        .game-btn:hover { background-color: #f0f0f0; }
        .game-btn:active { box-shadow: 0px 0px 0px #212121; transform: translate(4px, 4px); }
        .game-btn-primary { background-color: #2979ff; color: white; }
        .game-btn-primary:hover { background-color: #2962ff; }
        .game-btn-success { background-color: #00c853; color: white; }
        .game-btn-success:hover { background-color: #00c853; }
        .game-input { background-color: white; border: 3px solid #212121; font-size: 16px; padding: 12px; width: 100%; }
        .game-input:focus { outline: none; border-color: #2979ff; }
        .progress-container { border: 3px solid #212121; background-color: #e0e0e0; padding: 4px; }
        .progress-bar-inner { background-color: #2979ff; transition: width 0.5s ease-out; height: 16px; }
        .loader { width: 48px; height: 48px; border: 5px solid #212121; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; }
        .toast { background-color: #212121; color: white; padding: 20px; border-top: 4px solid #9e9e9e; animation: slide-up 0.3s ease-out, slide-down 0.3s ease-in 2.7s forwards; font-size: 14px; text-align: center; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slide-down { from { transform: translateY(0); } to { transform: translateY(100%); } }
        #myListPanel { border-left: 4px solid #212121; background-color: #f0f0f0; transition: transform 0.4s ease-in-out; transform: translateX(100%); }
        #myListPanel.open { transform: translateX(0); }
        #panel-overlay { transition: opacity 0.4s ease-in-out; backdrop-filter: blur(2px); }
        
        /* New styles for progressive image loading */
        .img-placeholder {
            width: 100%;
            aspect-ratio: 245 / 342; /* Standard Pokémon card aspect ratio */
            background-color: #d1d5db; /* gray-300 */
            border: 4px solid #212121;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="antialiased">
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-4 md:p-8 relative z-10">
        <!-- Header -->
        <header class="text-center mb-10 p-4"><h1 class="text-3xl md:text-4xl font-black mb-2 tracking-tighter">POKéMON TCG TRACKER</h1></header>

        <!-- Main Content Box -->
        <div class="game-box p-4 md:p-6">
            <!-- Progress & Controls -->
            <div class="mb-6 pb-6 border-b-4 border-dashed border-gray-300">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-6">
                    <div class="w-full sm:w-2/3">
                        <div class="flex justify-between items-center mb-2 text-xs">
                            <span class="font-semibold">PROGRESS</span>
                            <span id="progressText" class="font-bold">0/1025</span>
                        </div>
                        <div class="progress-container"><div id="progressBar" class="progress-bar-inner" style="width: 0%"></div></div>
                    </div>
                    <button id="showListBtn" class="w-full sm:w-auto game-btn py-3 px-6 text-sm">> MY LIST</button>
                </div>
            </div>

            <!-- Search -->
            <div id="searchView">
                <div class="max-w-xl mx-auto mb-6"><input type="text" id="searchInput" class="game-input text-center" placeholder="Search Name or ID"></div>
                <main id="results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></main>
            </div>
             <!-- Loader -->
            <div id="loader" class="hidden text-center py-10"><div class="loader"></div></div>
        </div>

        <!-- Footer for User ID -->
        <footer class="text-center mt-4"><p id="userIdDisplay" class="text-gray-500 text-xs"></p></footer>
    </div>
    
    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-70">
        <div class="relative max-w-lg max-h-full game-box p-2">
            <img id="modalImage" src="" alt="Pokémon Card Large View" class="w-full">
            <button id="closeModal" class="absolute -top-4 -right-4 bg-red-500 text-white border-2 border-black h-10 w-10 font-mono text-2xl flex items-center justify-center hover:bg-red-600">[X]</button>
        </div>
    </div>

    <!-- "My List" Slide-in Panel -->
    <div id="panel-overlay" class="fixed inset-0 bg-black/30 z-30 hidden"></div>
    <aside id="myListPanel" class="fixed top-0 right-0 h-full w-full max-w-md p-6 z-40 flex flex-col">
        <div class="flex justify-between items-center mb-6 pb-4 border-b-4 border-black">
            <h2 class="text-2xl font-bold">MY LIST</h2>
            <button class="text-gray-600 hover:text-black transition-colors text-3xl" onclick="toggleListPanel(false)">[X]</button>
        </div>
        <div id="myListContainer" class="flex-grow overflow-y-auto pr-2 space-y-4"></div>
    </aside>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>
</body>
</html>
